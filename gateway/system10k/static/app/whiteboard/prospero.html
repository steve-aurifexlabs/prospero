<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAICAAAAEAGACoDAAAFgAAACgAAAAgAAAAQAAAAAEAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLU1dPU1dPU1dPU1dPT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NHT1NHT1NHT1NHT1NLT1NLT1NLT1NLT1NLT1NLT1NLT1NHT1NHT1NHT1NHT1NHT1NLU1dPU1dPU1dPU1dPU1dPU1dPT1NHT1NLT1NLT1NLT1NLT1NLT1NHT1NHT1NHV1tLV1tLV1tLV1tLV1tLU1dPU1dPU1dPU1dPU1dPU1dPV1tLV1tLV1tLV1tLV1tLV1tLU1dPV1tTV1tTW19XW19XX2NbU1dHU1dHU1dHU1dHU1dHU1dHV1tLV1tLV1tLU1dHU1dHU1dHU1dHU1dHT1NLT1NLT1NLT1NLT1NLT1NHU1dHU1dHU1dHV1dHU1dHU1dLV1tTV1tXW19bW19bY2dfY2dfU1dHU1dHU1dHU1dHU1dHU1dHU1dHU1dHU1dHS1dTS1NTS1NTS1NTU1dPZ19PV19LP1NDT2NTU2NTR08/Z2NXY19TT08/a2dbQ0c/a3NrZ3OHX2t7Y29/i5Ofg4uLd39/X2NjY19bW1NPX1dTV2NPR1dDS1NTS1NTS1NTT1dPT1dPT1dPT1dPU1dPV09PW1tbb3d3a3d7d3eDh4OPV19fS1NPU1tXS1NTX2djg4N739vP08vDx8Ozt7urq6uXs7Ojf4+Lc3dvU0tHV1NLV1dHS1NDT1dPT1dPT1dPW1dHW1dHW1dHW1dHX1tTZ2dnh4t/o6Ofk4+Ld2tva2NrZ3NzT1dXS19bU1tbd3tz09PLd2M7RzcLc2c3OzMLT0cnq6OHi6ejb393S09HW1NPW1dHX1tLW1dHW1dHW1dHW1dHW1dHW1dHX1tLV1dLf4d3v8Ojn5t7o5t7y7+n18u/r7Oni4+Ph4uLp6efx8OvX08zCvK6zrZ6spZi5tKnb2dLx8u3a4N/X2tjS0tDX1dPW1dHX1tLW1dHW1dHW1dHW1dHW1dHW1dHX1tLV1dPi4+Lp6uLLyr++u7DDv7bIxbzl4dru7ejt7uny7+nh28+0raCppJewqpyzrZ/Uz8fw7+3k5+fX2tnU1tPU0tHW1NPU1NDS1tHW1dHW1dHW1dHU1dPU1dPV1tTV1tTS1NTd4OLz8fDx7eTu6t/l39bPysG7tqzBvrbRzsbOycC8s6WyqZiqppymoJPZ08jx7efs7e3M0NXc3NvX1tXY1tXX1dPS1dDS1tHU1dPU1dPU1dPT1NLT1NLT1NLT1NLU1dTW2Njc3t7g4ODp6efw8O3t7Onh39nFwLispZmtpZiro5apoZSxpZmropXQy8Lx8Ozj4+Xe4efc3uPV2dvR1tXX3djU1NHZ1tPU1tTU1dPU1dPU1dPU1dPU1dPU1dPV1tTT09LX19bY2dfW1tXc3Nzl5uT29fHj4dnCvLKrpJero5alnI+sopWimo3Fv7Pg3NXp5+Tu7evw7vHq7Oza3t3T2dfV2trS1NfT1NLT1NLT1NLW1NPW1NPW1NPW1NPV1NLW1dHa2tbS0tHU1dXZ29zb3d3s7ezg3tm/urClnpGooJOmnZCnn5C3saO3s6i4s6nEv7bGwbni2tTm49z8+/P1+PPm6+rT2NnU1dPU1dPU1dPW1dHW1dHW1dHW1dHV1dDV1dDZ2dXS09LW19fe3+Dl5ubt7OnNysKyraOlnpGnn5Knn5K5tKjd2dDu7OXk4tri3tXPzMC5r6LNxLfVzsPY1s3w8Ovf4d/W19XW19XV1tTV1NDV1NDV1NDV1NDV1dHR0s7W19TV1dTT09Pi4eLx7+/j39a2saerpJiooJKqopW2sKPc2dHy8e3m5ujn6Onu7urz8uvc1s/GwLjFwLfU0Mrs7OXk5uPV1tTV1tTV1tTV1NDV1NDV1NDV1NDU1NHR1dPV19XU1dLf3t7r6urq6OXOxrqooJOupZetpZexqZzUzsP18u7l5ejY2+Pb3uXV2Nri4+Hy9fb09PP7+/j29vTr7OvU2NfU1dPT1NLT1NLW1dHW1dHW1dHW1dHV1M7X1s/X2NbV19fe39/19PDSzMivqqKrpZinoJGsppjMx7zt6eHo6u7a3d3Y3NnV19LV1tPd3tzZ293U1tfU1tfZ29zY2tvS1NXW1dHW1dHW1dHW1dHW1dHW1dHW1dHX1dHX1dLV1tXU1tbp6ujr6OTHwrurpJmvqJurpZa4s6fl4dn59/LZ293W2NjT1tTV1tLU1dPS1NLZ2tnZ2tnY2tnY2tnV19bT1dTW1dHW1dHW1dHV1NDV1NDV1NDV1NDV1NHV09LV1NbY2trx8O7k4dnBvLGtpZeooZKppJbJxrzq6uXp6+nY29vV2NfT1NDT1NDU1dPU09HQ0c3T1NHV1tLS09DS08/T1NDW1dHW1dHV1NDV1NDV1NDV1NDV1NDU09DW1NTZ2dvf4OHs6+nd2tK1r6Omno+imo22safZ19Hq7evh5uXZ2trT09LT1NDT08/T0tDX1dTS08/S08/S08/S08/T1NDU1dHV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NHV09Lh4OHk5OXp5+TTzcavqJ2kno+ppJfKxb7q6eTp6+rR19XW1tTS08/V19LX1tLU0tHW1NPW1tLT08/T08/T1NDT1NDT08/V1NDV1NDV1NDV1NDV1NDV1NDV1NDX1tLQzszj4+Pj4uLt6ufGwLu0q6KloJLJxLrp493u7erg4+HU2tnU1dPT1NHR0szU1M/X1dPS0NDU08/V1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDW1dDT08/c393n6Ojo5uPNx8CupJm6r6PX1Mv29fXh4eHa29nX1dPW1dHW1dHV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NHT1NLb3d3g4uHt6+fX08m1q6HMxbrq5uHr7ezc3t7V1dXX2NXW1dHW1dHW1dHV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDU08/U08/U08/U08/S08/S1dPa3dzg4uDv7enY08q4sabf29T39fDX2dnV19fS1NTS09LW1NDV1NDV1NDV1NDV1NDV1NDU08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/S09DQ09HX2tjh4uDu7Ofg3dXPzMXz8+7f4N7a3dvQ0tLP0dHR09HU08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/U08/V1dDU1dDU1NDb3Nfo6OTt7err7Ofu7+zY2dTc3NrT1NHV1dLT09DU1M7U1M7U1M7U1M7U1M7U1M7U08/U08/U08/U08/U08/U08/U08/U08/U08/V1NDV1NDV1NDV1NDV1c/W1s7V1c3V1tDb3dre4uHc4N7Y2dXY2dPY19LU087V1M/V1dDV1c/V1c/V1c/W1tDW1tDW1tDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1NDV1c/V1c/V1c/V1c/V1c7V1c7V1c/W1dHY1tTY1tXY19XV1c/U1M7V1c/V1c/V1c/U1M7V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c7U1M3U1M7V1NDV09HW09PV1NHV1c/U1M7V1c/V1c/V1c/U1M7V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/U1M/U08/U0tDU08/V1c/U1M7V1c/V1c/V1c/U1M7V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1NDV1NDV1NDV1c/U1M7V1c/V1c/V1c/U1M7V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c/V1c8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==">
    <title>Prospero.Live</title>

    <link href="https://fonts.googleapis.com/css2?family=Nunito&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Madurai&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cousine&display=swap" rel="stylesheet">

    <script src="/lib/codemirror/codemirror.js"></script>
    <link rel="stylesheet" href="/lib/codemirror/codemirror.css">
    <link rel="stylesheet" href="/lib/codemirror/theme/vscode-dark.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/theme/mbo.css"> -->
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/javascript/javascript.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/xml/xml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/css/css.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/htmlmixed/htmlmixed.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/markdown/markdown.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/json/json.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/shell/shell.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/http/http.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/nginx/nginx.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/wast/wast.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/yaml/yaml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/mode/clike/clike.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/scroll/simplescrollbars.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/scroll/simplescrollbars.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/dialog/dialog.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/dialog/dialog.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/search/searchcursor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/search/search.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/search/jump-to-line.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/edit/matchbrackets.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/edit/closebrackets.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/fold/xml-fold.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/edit/matchtags.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/edit/closetag.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/addon/comment/comment.js"></script>
    
    <!-- <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/keymap/sublime.js"></script> -->
    <script src="/lib/sublime-cm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/keymap/emacs.js"></script>

    <!-- <script src="https://js.stripe.com/v3/"></script> -->
</head>
<body>

<style>
@font-face {
    font-family: 'Averia Sans Libre';
    font-style: normal;
    font-weight: 400;
    font-display: fallback;
    src: local('Averia Sans Libre Regular'), local('AveriaSansLibre-Regular'), url('averiasanslibre.woff2') format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

body { font-family: 'Nunito', sans-serif; }
button { font-family: 'Nunito', sans-serif; }
input { font-family: 'Nunito', sans-serif; }

body { background-color: rgb(245, 255, 243); }

button {
    padding: 5px;
    margin: 5px;
    background-color: rgb(193, 251, 138);
    border-radius: 5px;
    border: 1px solid #ccc;
}

button:hover {
    background-color: rgb(171, 255, 92);
    cursor: pointer;
}
</style>

<style>
body { padding: 0; margin: 0; }
body { font-size: 100%; }
h2 { margin: 0; }
footer { font-size: 75%; }
footer a { padding: 5px; }
pre { font-family: 'Inconsolata', monospace}

#main { position: fixed; top: 0px; bottom: 28px; width: 100%; overflow: auto; }
/* #main { background: repeat url(data:image/png;base64,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); } */
footer { position: fixed; bottom: 0px; height: 18px; left: 10px; right: 10px; }
footer { background: repeat url(data:image/png;base64,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); }
footer { outline: 1px solid #ddd; box-shadow: 1px 1px 1px 1px #ccc;}
/* footer { margin-top: 5px; } */

#timeline { position: fixed; bottom: 28px; height: 30px; width: 1250px; }
#timeline { outline: 1px solid #ddd; box-shadow: 1px 1px 1px 1px #ccc; }
#timeline canvas { width: 100%; height: 100%; background-color: white; }
#timeline { left: 50%; transform: translate(-50%, 0%); }

.toast { background: repeat url(data:image/png;base64,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); }

#tabs { position: fixed;  top: 0px; height: 25px; left: 261px; right: 190px; overflow: hidden; }

#doc-header { position: fixed;  top: 25px; height: 56px; left: 260px; right: 203px; overflow: hidden; }
#doc-header { background: repeat url(data:image/png;base64,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); }
#doc-header { border: 1px solid #ddd; border-bottom: none; box-shadow: 1px 1px 1px 1px #ccc;}

/* #main-view { position: fixed; top: 25px; bottom: 28px; left: 260px; right: 203px; border: 1px dotted #444; border-top: none; overflow: auto; } */
#main-view { position: fixed; top: 80px; bottom: 68px; left: 260px; right: 203px; border: 1px solid #ddd; overflow: auto; box-shadow: 1px 1px 1px 1px #ccc;}
#main-view { background: repeat url(data:image/png;base64,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); }
#main-view { border-top: 3px solid #efe;}

#left-panel { background-color: #111; z-index: 100;}
#left-panel { background: repeat url(data:image/png;base64,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); }
#right-panel { background-color: #555; }
#right-panel { background: repeat url(data:image/png;base64,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); }

#left-panel { position: fixed; top: 18px; bottom: 68px; left: 0px; width: 250px; outline: 1px solid #ddd; overflow: auto; white-space: nowrap; box-shadow: 1px 1px 1px 1px #ccc; }
#right-panel { position: fixed; top: 10px; bottom: 68px; right: 0px; width: 193px; outline: 1px solid #ddd; overflow: auto; box-shadow: 1px 1px 1px 1px #ccc; }
#center-panel { z-index: 50; position: fixed; right: 200px; height: 100%; overflow: auto; }
#status-bar { position: fixed; left: 150px; font-size: 14px; }
#fps { position: fixed; left: 15px; font-size: 14px; }

#tabs > * { box-shadow: 1px 1px 1px 1px #ccc; }
#tabs > * { cursor: pointer; display: inline; white-space: nowrap; overflow: hidden; }
#tabs > * { font-size: 16px; padding: 5px; margin: 0px; }
#tabs > * { border-right: 1px solid #444; background: #ddd; color: #444 }
/* #tabs > *.selected { background: #ddd; color: #222; } */
#tabs > *.selected { cursor: default; background: repeat url(data:image/png;base64,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); }
#tabs > * > span { display: inline-block; width: 222px; overflow: hidden; }
#tabs > * > a { cursor: pointer; padding: 0 2px; font-size: 14px; position: relative; top: -6px; right: -4px; }

#left-panel { font-family: 'Inconsolata', monospace; font-size: 90%; }
#left-panel pre { padding: 2px; margin: 0px; cursor: pointer; }
#left-panel .folder { font-weight: 700; }

.file.selected { background: #444; }

video {
    width: 100%;
    max-height: 100%;
    padding: 0;
    margin: 0;
}

video.preview {
    cursor: pointer;
}

#more-tabs {
    font-size: 90%;
    background-color: #fff;
    color: #222;
    position: fixed;
    top: 2px;
    right: 205px;
    padding: 0 6px;
    border-radius: 8px;
    display: none;
}

#offline { color: #666; }
#invited { color: #888; }

#left-panel:hover {
    overflow-x: visible;
}

#left-panel > :hover {
    background-color: #eee;
    overflow-x: visible;
}

#context-menu {
    display: none;
    position: fixed;
    background-color: #fff;
    border: 1px solid #888;
    border-radius: 5px;
    font-size: 90%;
    min-width: 200px;
}

#context-menu > p {
    padding: 6px;
    margin: 4px 0;
    cursor: pointer;
}

#context-menu > p:not(.disabled):hover {
    background-color: #eee;
}

#context-menu > .disabled {
    cursor: default;
}

#context-menu hr {
    width: 100%;
    border-top: none;
    border-bottom: 1px solid #eee;
    margin: 0;
    padding: 0;
}
/* 
.editor .code pre {
    display: inline;
} */
/* 
.CodeMirror-scroll {
    min-height: 1000px;
} */

.CodeMirror-simplescroll-horizontal {
    height: 24px;
}

.CodeMirror-simplescroll-vertical {
    width: 24px;
}

video.gallery {
    width: 45%;
    border-radius: 10px;
    margin: 5px;
}

iframe.pdf {
    width: 100%;
    height: 800px;
}

.started-message p {
    margin: 3px;
}

.started-message p:first-child {
    margin-top: 20px;
    margin-bottom: 15px;
}
</style>

<style>
    .CodeMirror {
        height: auto;
        font-size: 14px;
        font-family: "Cousine", monospace;
    }

    .CodeMirror-gutter {
        margin-right: 20px;
    }
    .cm-s-vscode-dark .CodeMirror-gutters {
        background-color: #333;
    }
    
    .CodeMirror-linenumber {
        margin-left: 8px;
    }

    .CodeMirror-lines {
        margin-left: 2px;
    }

    .CodeMirror pre.CodeMirror-line {
        margin-left: 0px;
    }

    .cm-s-vscode-dark .CodeMirror-cursor {
        border-left: 2px solid #ffffecaa;
    }

    .CodeMirror {
        position: fixed;
        top: 80px;
        bottom: 69px;
        left: 261px;
        right: 204px;
    }
    .cm-s-vscode-dark.CodeMirror {background: #444;}
</style>

<style>
    #lock-icon {
        font-size: 22px;
    }
    
    #right-panel button {
        font-size: 22px;
    }

    #right-panel form[name="invite"] button {
        font-size: initial;
    }

    canvas.audio {
        width: 100%;
        height: 20px;
        margin-top: -4px;
    }

    #modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        height: 300px;
        width: 500px;
        max-width: 100%;
        max-height: 100%;
        padding: 20px;
        z-index: 100;
        background-color: #fff;
        border: 1px solid #555;
        border-radius: 3px;
        box-shadow: 1px 1px 1px 1px #ccc;
    }
    
    #modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 99;
        /* background-color: #dddddddd; */
        background-color: rgba(245, 255, 243, 0.9);
    }

    #modal button.close {
        float: right;
        border: none;
        background: #fff;
        padding: 10px 15px;
        margin-top: -10px;
        margin-right: -10px;
        /* position: absolute; */

    }

    #modal { background: repeat url(data:image/png;base64,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); }
    
    .edit-preview {
        font-size: 90%;
        background-color: #222;
        color: #aab;
        overflow: hidden;
    }
</style>


<div id="main">
    <span style="float: left; font-family: Hind Madurai; font-size: 110%; margin-top: -2px; padding: 0 5px;">Prospero.Live</span>
    <a style="float: left; font-size: 75%; padding: 0 100px;" href="/teams">Teams</a>
    <!-- <a style="float: left; font-size: 75%; padding: 0 5px;" href="/teams">Settings</a> -->
    <!-- <a style="float: right; font-size: 75%; padding: 0 5px;" href="/account">Account</a> -->
    <!-- <a style="float: right; font-size: 75%; padding: 0 5px;" href="/logout">Logout</a> -->
    <div id="left-panel">
        <p>Loading...</p>
    </div>

    <div id="center-panel">
        <div id="tabs"></div>
        <div id="doc-header">
            <h2 style="display: inline-block; padding: 15px; font-size: 18px;"></h2>
            <div style="float: right; margin: 6px;"></div>
        </div>
        <div id="main-view"></div>
    </div>
    
    <div id="right-panel">
        <p style="font-size: 75%; margin: 1px; text-decoration: underline;">Online</p>
        <div style="margin: 5px; border-radius: 10px; border: solid 5px #222; background-color: #fff;">
            <p name="your-email" style="margin: 0; padding-left: 3px; overflow: hidden; white-space: nowrap; border-bottom: solid 1px #ddd;"></p>
            <button style="font-size: 90%;" name="share-video" type="click">🎥🎙️ Share cam/mic</button>
            <button style="font-size: 90%;" name="share-screen" type="click"> 🖥️ Share screen</button>
            <video style="display: none;" name="local-video" class="preview" autoplay muted></video>
            <video style="display: none;" name="local-screen" class="preview" autoplay muted></video>
            <!-- <canvas style="display: none;" class="audio" height="20px"></canvas> -->
            <!-- <canvas style="display: none; width: 100%; height: 90px;" class="demo"></canvas> -->
            <div style="display: none; width: 100%; height: 85px;" class="demo"></div>

        </div>
        <div style="margin-top: 15px;" id="offline"></div>
        <div style="margin-top: 15px;" id="invited"></div>
        <!-- <p style="font-size: 75%; margin: 1px; margin-top: 15px; text-decoration: underline;">Invite</p>
        <form name="invite">
            <input style="width: 50%; margin: 5px;" type="text" name="email" autocomplete="email" autofocus placeholder="Email">
            <button>Invite</button>
            <p style="font-size: 90%; margin: 0 15px;" name="message"></p>
        </form> -->
    </div>
</div>

<div id="timeline">
    <canvas style="width: 100%; height: 100%;"></canvas>
</div>

<footer>
        <span id="status-bar">Loading...</span>
        <span id="fps"></span>
        <span style="position: fixed; right: 35px;">
            <a href="/">Home</a>
            <a href="/terms-of-service" target="_blank">Terms</a>
            <a href="/privacy-policy" target="_blank">Privacy</a>
            <a href="mailto:contact@aurifexlabs.com">Contact</a>
            <span>Copyright 2019-2020 Aurifex Labs LLC</span>
        </span>
        <img style="position: fixed; right: 10px;" src="data:image/jpeg;base64,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">
</footer>

<div id="more-tabs"><span>0</span> more</div>
<div id="context-menu"></div>
<div id="modal"></div>
<div id="modal-overlay"></div>

<div id="getting-started" style="display: none;">
    <h2>Getting Started</h2>
</div>

<script>
    var demoCanvas = document.querySelector('.demo')
    
    var clipboard
    var openFolders = []

    var user
    var yourEmail
    
    var shortTeamId = location.search.split('id=')[1].slice(0, 4)
    var team

    var webSocket

    var localVideoStream
    var localScreenStream

    var colors = ['#8af', '#fb2', '#afa', '#ff3', '#f33', '#3ff', '#3f3', '#33f']
    var colorCursor = 0

    var assignedColors = {}

    var activeTab

    var firstClick = false
    
    window.addEventListener('DOMContentLoaded', function (event) {
        getUser(function() {
            loadPage()
        })        
    })

    function loadPage() {
        yourEmail = user.email
        
        document.title = shortTeamId + ' | Prospero.Live'
        document.querySelector('[name="your-email"]').textContent = user.email

        updateOfflineList()
        updateInvitedList()

        document.querySelector('button[name="share-video"]').addEventListener('click', function() {
            document.querySelector('[name="local-video"]').style.display = 'inline'
            shareVideo()
        })
        
        document.querySelector('button[name="share-screen"]').addEventListener('click', function() {
            document.querySelector('[name="local-screen"]').style.display = 'inline'
            shareScreen()    
        })

        window.addEventListener('click', function() {
            firstClick = true
            if(team) {
                Object.values(team.members).forEach(function(peer) {
                    var peerElement = peer.peerElement
                    if(peerElement !== undefined) {
                        var peerCameraElement = peerElement.querySelector('[name="camera"]')
                        peerCameraElement.muted = false
                    }
                })
            }
        })
    
        // registerInviteHandler()

        connect()

        setInterval(function () {
            if(webSocket === undefined || webSocket.readyState == WebSocket.CLOSED) {
                connect()
            }
       
            else if (webSocket.readyState == WebSocket.OPEN) {
                webSocket.send(JSON.stringify({
                    type: 'ping',
                    time: Date.now(),
                }))
            }
        }, 3 * 1000)

        startTimeline()
    }



    function openModal(elm) {
        var modal = document.querySelector('#modal')
        var modalOverlay = document.querySelector('#modal-overlay')

        modal.innerHTML = '<button class="close">X</button>'
        var closeButton = modal.querySelector('button.close')
        modal.appendChild(elm)
        
        modal.style.display = 'block'
        modalOverlay.style.display = 'block'
        
        modal.querySelector('button.close').addEventListener('click', function() {
            closeModal()
        })
        modalOverlay.addEventListener('click', function() {
            closeModal()
        })
    }
    
    function closeModal() {
        document.querySelector('#modal').style.display = 'none'
        document.querySelector('#modal-overlay').style.display = 'none'
    }

    // function registerInviteHandler() {
    //     var form = document.querySelector('form[name="invite"]')
        
    //     form.addEventListener('submit', function(event) {
    //         event.preventDefault()

    //         var message = form.querySelector('[name="message"]')

    //         var email = form.querySelector('input[name="email"]').value
    //         if(!email || !email.includes('@') || email.length > 254) {
    //             message.textContent = 'Please enter a valid email address.'
    //             return
    //         }

    //         message.textContent = 'Sending request...'
    //         fetch('/api/invite?email=' + encodeURIComponent(email) + '&teamId=' + encodeURIComponent(team.teamId), {
    //             method: 'POST',
    //             headers: {
    //                 Authorization: 'Bearer ' + localStorage.sessionId,
    //             },
    //         }).then(function(response) {
    //             if(response.ok) {
    //                 message.textContent = ''
    //                 form.querySelector('input[name="email"]').value = ''
    //             }
                
    //             else if(response.status == 409) {
    //                 message.textContent = 'Already invited.'
    //                 form.querySelector('input[name="email"]').value = ''
    //                 setTimeout(function() {
    //                     message.textContent = ''
    //                 }, 10000)
    //             }

    //             else if(response.status == 401) {
    //                 location.href = '/'
    //             }

    //             else {
    //                 message.textContent = 'There was an error. Please try again.'
    //             }
    //         })

    //         return false
    //     })
    // }





    // function updateFile(path, name) {
    //     fetch('/api/file?team=' + team.teamId + '&path=' + path + '&filename=' + name, {
    //         headers: {     
    //             Authorization: 'Bearer ' + localStorage.sessionId,
    //         },
    //     }).then(function (response) {
    //         if (response.ok) {
    //             return response.text()
    //         }
            
    //         else if(response.status == 401) {
    //             unAuthed()
    //         }
    //     }).then(function(data) {
    //         if(!data) {
    //             return
    //         }

    //         // console.log('file:', data)

    //         var tabs = document.querySelector('#tabs')
    //         Array.from(tabs.children).forEach(function(tab) {
    //             if(tab.key == 'file:' + path + name) {
    //                 var view = tab.element
    //                 if(data.length < 400000) {
    //                     view.editor.setValue(data)
    //                 } else {
    //                     view.editor.setValue('This file is too large to open.')
    //                 }
    //             }
    //         })       
    //     })
    // }

    function updateFilesystem(done) {
        fetch('/api/folder?team=' + encodeURIComponent(team.teamId), {
            headers: {
                Authorization: 'Bearer ' + localStorage.sessionId,
            },
        }).then(function (response) {
            if (response.ok) {
                return response.json()
            }
            
            else if(response.status == 401) {
                unAuthed()
            }
        }).then(function(data) {
            if(!data) {
                return
            }
            
            // console.log('filesystem:', data)

            cleanTabs(data)
        
            var div = document.querySelector('#left-panel')
            div.innerHTML = ''
            
            var root = document.createElement('pre')
            root.style.fontSize = '26px'
            root.classList.add('folder')
            root.classList.add('open')
            root.textContent = '/'
            div.appendChild(root)

            if(data.length > 0) {
                root.emptyFolder = false
            } else {
                root.emptyFolder = true 
            }

            makeFolderClickable(root, '', '/')

            addFolder(root, data, '/', 0)   
            
            if(root.emptyFolder) {
                var msg = document.createElement('div')
                msg.classList.add('started-message')
                msg.style.paddingLeft = '20px'
                msg.innerHTML = '<p>Getting started:</p><p>Right-click on the</p><p>root folder (above)</p><p>to start working</p><p>with files.'
                div.appendChild(msg)
            }

            done && done()
        })
    }

    function addFolder(elm, folder, path, indentationLevel) {
        folder.sort(function(a, b) {
            if(a.type == 'folder' && b.type == 'file') {
                return true
            }

            else if(a.type == 'file' && b.type == 'folder') {
                return false
            }
            
            else {
                return a.name < b.name
            }
        })

        folder.forEach(function(entry) {
            var element = document.createElement('pre')
            elm.insertAdjacentElement('afterend', element)

            var prefix = ''
            for(var i = 0; i < indentationLevel; i++) {
                prefix += '  ';
            }

            if(entry.type == 'file') {
                element.classList.add('file')
                var icon = getIconFromFilename(entry.name)
                element.textContent = prefix + ' ' + icon + ' ' + entry.name
                makeFileClickable(element, path, entry.name)
            }
            
            else if(entry.type == 'folder') {
                element.classList.add('folder')
                makeFolderClickable(element, path, entry.name)

                element.contents = entry.contents
                element.indentationLevel = indentationLevel
                
                if(entry.contents.length > 0) {
                    element.emptyFolder = false
                } else {
                    element.emptyFolder = true 
                }

                if(openFolders.includes(path + entry.name + '/')) {
                    element.classList.add('open')
                    element.textContent = prefix + ' ▼ ' + entry.name
                    addFolder(element, entry.contents, path + entry.name + '/', indentationLevel + 1)
                }
                
                else {
                    element.textContent = prefix + ' ▶ ' + entry.name
                }
            }
        })
    }

    function cleanTabs(folder) {
        var flattenedFolder = flattenFolder(folder, '/')
        var tabs = document.querySelector('#tabs').children
        Array.from(tabs).forEach(function(tab) {
            if(tab.key.startsWith('file:') && !flattenedFolder.includes(tab.key.slice(5))) {
                // console.log(tab.key, flattenedFolder)
                closeTab(tab)
            }
        })
    }

    function flattenFolder(folder, path) {
        var result = []
        folder.forEach(function(entry) {
            if(entry.type == 'file') {
                result.push(path + entry.name)
            }
            
            else if(entry.type == 'folder') {
                result.push(path + entry.name)
                var nestedFolder = flattenFolder(entry.contents, path + entry.name + '/') 
                result = result.concat(nestedFolder)
            }
        })

        return result
    }

    function createFileView(name, path) {
        var div = document.createElement('div')
        div.filename = name
        div.filepath = path

        var message = document.createElement('p')
        message.textContent = 'Loading file...'
        message.style.fontSize = '16px'
        div.appendChild(message)

        fetch('/api/file?team=' + encodeURIComponent(team.teamId) + '&path=' + encodeURIComponent(path) + '&filename=' + encodeURIComponent(name) , {
            headers: {
                Authorization: 'Bearer ' + localStorage.sessionId,
            },
        }).then(function (response) {
            if (response.ok) {
                if(name.slice(-5).toLowerCase() == '.jpeg' || name.slice(-4).toLowerCase() == '.jpg' || name.slice(-4).toLowerCase() == '.png' || name.slice(-4).toLowerCase() == '.gif') {
                    return response.blob()
                }
                else if(name.slice(-5).toLowerCase() == '.webm' || name.slice(-4).toLowerCase() == '.mov' || name.slice(-4).toLowerCase() == '.mp4') {
                    return response.blob()
                }
                else if(name.slice(-4).toLowerCase() == '.pdf') {
                    return response.blob()
                }
                // else if(name.slice(-4).toLowerCase() == '.odt') {
                //     return response.blob()
                // }
                else if(name.slice(-4).toLowerCase() == '.wav' || name.slice(-4).toLowerCase() == '.mp3') {
                    return response.blob()
                }
                else {
                    return response.text()
                }
            }
            
            else if(response.status == 401) {
                unAuthed()
            }
        }).then(function(data) {
            message.remove()

            if(data === undefined || data === null) {
                var msg = document.createElement('p')
                msg.textContent = 'There was an error retreiving this file.'
                div.appendChild(msg)
            }

            else if(name.slice(-4).toLowerCase() == '.jpg' || name.slice(-5).toLowerCase() == '.jpeg' || name.slice(-4).toLowerCase() == '.png' || name.slice(-4).toLowerCase() == '.gif') {
                // codeElement.remove()  // .style.display = 'none'
                try {
                    var img  = document.createElement('img')
                    img.src = URL.createObjectURL(data)
                    img.style.maxWidth = '100%'
                    div.appendChild(img)
                } catch(err) {
                    var msg = document.createElement('p')
                    msg.textContent = 'Error previewing image.'
                    div.appendChild(msg)
                }

            }

            else if(name.slice(-4).toLowerCase() == '.mov' || name.slice(-5).toLowerCase() == '.webm' || name.slice(-4).toLowerCase() == '.mp4') {
                // codeElement.remove()  // .style.display = 'none'
                try {
                    var video  = document.createElement('video')
                    video.setAttribute('controls', true)
                    // video.style.maxHeight = '100%'
                    // div.style.maxHeight = '100%'
                    video.style.maxWidth = '100%'
                    video.src = URL.createObjectURL(data)
                    div.appendChild(video)
                } catch(err) {
                    var msg = document.createElement('p')
                    msg.textContent = 'Error previewing video.'
                    div.appendChild(msg)
                }
            }

            else if(name.slice(-4).toLowerCase() == '.wav' || name.slice(-4).toLowerCase() == '.mp3') {
                try {
                    var audio  = document.createElement('audio')
                    audio.setAttribute('controls', true)
                    // video.style.maxHeight = '100%'
                    // div.style.maxHeight = '100%'
                    // audio.style.maxWidth = '100%'
                    audio.src = URL.createObjectURL(data)
                    div.appendChild(audio)
                } catch(err) {
                    var msg = document.createElement('p')
                    msg.textContent = 'Error previewing audio.'
                    div.appendChild(msg)
                }
            }    

            else if(name.slice(-4).toLowerCase() == '.pdf') {
                try {
                    var pdf  = document.createElement('iframe')
                    pdf.classList.add('pdf')
                    pdf.src = URL.createObjectURL(new Blob([data], {
                        type: 'application/pdf',
                    }))
                    div.appendChild(pdf)
                } catch(err) {
                    var msg = document.createElement('p')
                    msg.textContent = 'Error previewing PDF.'
                    div.appendChild(msg)
                }
            }
            
            // else if(name.slice(-4).toLowerCase() == '.odt') {
            //     try {
            //         var doc  = document.createElement('iframe')
            //         doc.classList.add('pdf')

            //         doc.src = '/lib/viewerjs/#../../'
            //         div.appendChild(doc)
            //     } catch(err) {
            //         var msg = document.createElement('p')
            //         msg.textContent = 'Error previewing ODT.'
            //         div.appendChild(msg)
            //     }
            // }
            
            else if(data.length > 400000) {
                var msg = document.createElement('p')
                    msg.textContent = 'This file is too large to edit. (>400kB)'
                div.appendChild(msg)
            }
            
            else {
                
                var editor = createEditor(div, data, name, path)
                div.editor = editor
                div.classList.add('editor-wrapper')

                // console.log(data)
                // code.innerHTML = ''
                // code.appendChild(editor)
                // addCursors(editor)
            }
            // console.log('filesystem:', data)
        })

        return div
    }

    function getIconFromFilename(name) {
        // console.log(name)
        if(name.slice(-5).toLowerCase() == '.jpeg' || name.slice(-4).toLowerCase() == '.jpg' || name.slice(-4).toLowerCase() == '.png' || name.slice(-4).toLowerCase() == '.gif') {
            return '🖼️'
        }
        else if(name.slice(-5).toLowerCase() == '.webm' || name.slice(-4).toLowerCase() == '.mov' || name.slice(-4).toLowerCase() == '.mp4') {
            return '🎞️'
        }
        else if(name.slice(-4).toLowerCase() == '.pdf' || name.slice(-4).toLowerCase() == '.doc') {
            return '📄'
        }
        else if(name.slice(-4).toLowerCase() == '.wav' || name.slice(-4).toLowerCase() == '.mp3') {
            return '🎵'
        }
        else {
            return '≡'
        }
    }

    var crcTable = (function() {
        var c;
        var crcTable = [];
        for(var n =0; n < 256; n++){
            c = n;
            for(var k =0; k < 8; k++){
                c = ((c&1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
            }
            crcTable[n] = c;
        }
        return crcTable;
    })()

    var crc32 = function(str) {
        var crc = 0 ^ (-1);

        for (var i = 0; i < str.length; i++ ) {
            crc = (crc >>> 8) ^ crcTable[(crc ^ str.charCodeAt(i)) & 0xFF];
        }

        return (crc ^ (-1)) >>> 0;
    }

    function createEditor(parentElement, inputData, name, path) {
        var readOnly = true

        var mode = null
        if(name.slice(-3) == '.md') mode = 'markdown'
        if(name.slice(-5) == '.html') mode = 'htmlmixed'
        if(name.slice(-3) == '.js') mode = 'javascript'
        if(name.slice(-4) == '.css') mode = 'css'
        if(name.slice(-5) == '.http') mode = 'http'
        if(name.slice(-5) == '.json') mode = 'javascript'
        // if(name.slice(-6) == '.nginx') mode = 'nginx'
        // if(name.slice(-5) == '.wast') mode = 'wast'
        if(name.slice(-4) == '.yml') mode = 'yaml'
        if(name.slice(-3) == '.sh') mode = 'shell'
        if(name.slice(-2) == '.c' || name.slice(-2) == '.h') mode = 'clike'

        var editor = CodeMirror(parentElement, {
            value: inputData,
            lineNumbers: true,
            readOnly: readOnly,
            mode: mode,
            theme: 'vscode-dark',
            // theme: 'mbo',
            // cursorHeight: 2.0,
            // lineWrapping: true,
            scrollbarStyle: 'native',
            smartIndent: true,
            electricChars: false,
            keyMap: editorKeymap,
            indentUnit: 4,
            matchBrackets: true,
            matchTags: true,
            autoCloseBrackets: true,
            autoCloseTags: true,   
        })
        
        editor.filename = name
        editor.filepath = path

        editor.revisionId = 0
        // editor.unconfirmedChanges = 0
        editor.refreshing = false

        editor.beforeContents = editor.getValue()
        editor.beforeChecksum = crc32(editor.beforeContents.toString('binary'))
        editor.history = [{
            checksum: editor.beforeChecksum,
            contents: editor.getValue(),
        }]

        editor.checksumTable = {}
        editor.checksumTable[editor.beforeChecksum] = {
            index: 0,
            contents: editor.beforeContents,
            historyEntry: editor.history[0],
        }

        editor.on('inputRead', function(cm, change) {
            Object.keys(team.members).forEach(function(peerEmail) {
                var peer = team.members[peerEmail]

                var size = getChangeSize(change)
                if(peer.cursorPos && change.from.line < peer.cursorPos.line) {
                    handlePeerMessage({
                        type: 'cursor-position',
                        filepath: editor.filepath,
                        filename: editor.filename,
                        line: peer.cursorPos.line + size.lines,
                        ch: peer.cursorPos.ch,
                    }, null, peerEmail)
                }
                
                else if(peer.cursorPos && change.from.line == peer.cursorPos.line && change.from.ch <= peer.cursorPos.ch) {
                    handlePeerMessage({
                        type: 'cursor-position',
                        filepath: editor.filepath,
                        filename: editor.filename,
                        line: peer.cursorPos.line,
                        ch: peer.cursorPos.ch + size.chars,
                    }, null, peerEmail)
                }
            })
        })


        editor.on('keydown', function(cm, event) {
            // console.log('keydown', event)

            // console.log('crc32', crc32(editor.getValue()))

            var navKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'PageUp', 'PageDown', 'Home', 'End']
            if(editor.options.readOnly && !navKeys.includes(event.key)) {
                toast('Press the "Edit" button to start editing.', 3)
            }
        })

        editor.on('cursorActivity', function(cm) {
            var cursor = cm.getCursor()
            // console.log('cursorActivity', cursor)
            
            function getNearby1() {
                var centerY = cursor.line
                if(cursor.line < 2) {
                    centerY = 2
                }
                
                var nearby = editor.getRange({
                line: centerY - 2,
                ch: 0,
                }, {
                    line: centerY + 3,
                    ch: 0,
                })
                
                var n = 9
                
                var lines = nearby.split('\n').slice(0, 5)
                lines.forEach(function(line, i) {
                    line = line.padEnd(cursor.ch + (2 * n), ' ')
                    
                    var start = cursor.ch - n
                    if(start < 0) {
                        start = 0
                    }
                    
                    var aPadding = n
                    if(cursor.ch < n) {
                        aPadding = cursor.ch
                    }
                    var a = line.slice(start, cursor.ch).padStart(aPadding, ' ')
                    
                    var end = cursor.ch + (2 * n) - aPadding
                    if(end > line.length - 1) {
                        end = line.length - 1
                    }
                    
                    var b = line.slice(cursor.ch, end).padEnd((2 * n) - aPadding, ' ')
                    
                    // lines[i] = (cursor.line + i + 1).toString() + ': ' + a + b
                    lines[i] = (centerY + i - 1).toString() + ':' + a + b
                })

                return lines.join('\n')
            }
            
            function getNearby2() {
                var centerY = cursor.line
                if(cursor.line < 1) {
                    centerY = 1
                }
                
                var nearby = editor.getRange({
                line: centerY - 1,
                ch: 0,
                }, {
                    line: centerY + 2,
                    ch: 0,
                })
                
                var n = 11
                
                var lines = nearby.split('\n').slice(0, 3)
                lines.forEach(function(line, i) {
                    line = line.padEnd(cursor.ch + (2 * n), ' ')
                    
                    var start = cursor.ch - n
                    if(start < 0) {
                        start = 0
                    }
                    
                    var aPadding = n
                    if(cursor.ch < n) {
                        aPadding = cursor.ch
                    }
                    var a = line.slice(start, cursor.ch).padStart(aPadding, ' ')
                    
                    var end = cursor.ch + (2 * n) - aPadding
                    if(end > line.length - 1) {
                        end = line.length - 1
                    }
                    
                    var b = line.slice(cursor.ch, end).padEnd((2 * n) - aPadding, ' ')
                    
                    // lines[i] = (cursor.line + i + 1).toString() + ': ' + a + b
                    lines[i] = a + b
                })

                // var headingLength = 40 - (cursor.line.toString().length + cursor.ch.toString().length + 2)
                var headingLength = 20

                // var heading = (editor.filepath + editor.filename).slice(-headingLength).padEnd(headingLength, ' ') + ' ' + cursor.line + ':' + cursor.ch
                // var heading = (editor.filepath + editor.filename).slice(-headingLength)
                var heading = (editor.filename).slice(-headingLength)
                var pos = ((cursor.line + 1) + ':' + (cursor.ch + 1)).padStart(headingLength, ' ')
                // lines = ([heading.slice(0, 20), heading.slice(20, 40)]).concat(lines)
                lines = ([heading]).concat(lines).concat([pos])
                // lines = ([editor.filename, cursor.line + ':' + cursor.ch]).concat(lines)
                return lines.join('\n')

            }
            // nearby = lines.slice(0, lines.length - 1).join('\n')
            // nearby = lines.join('\n')
            var nearby = getNearby2()

            // console.log(nearby)
            document.querySelector('.demo').style.fontSize = '90%'
            document.querySelector('.demo').style.backgroundColor = '#222'
            document.querySelector('.demo').style.color = '#aab'
            document.querySelector('.demo').style.overflow = 'hidden'
            document.querySelector('.demo').innerHTML = '<pre style="margin: 0; font-family: Cousine, monospace;">' + sanitizeHTML(nearby) + '</pre>'
            
            webSocket.send(JSON.stringify({
                type: 'cursor-position',
                line: cursor.line,
                ch: cursor.ch,
                index: editor.indexFromPos({
                    line: cursor.line,
                    ch: cursor.ch,
                }),
                filepath: editor.filepath,
                filename: editor.filename,
                time: Date.now(),
                nearby: nearby,
            }))

            Object.values(team.members).forEach(function(teammate) {
                if(teammate.online) {
                    if(team.dataChannel && teammate.dataChannel.readyState == 'open') {
                        teammate.dataChannel.send(JSON.stringify({
                            type: 'cursor-position',
                            line: cursor.line,
                            ch: cursor.ch,
                            index: editor.indexFromPos({
                                line: cursor.line,
                                ch: cursor.ch,
                            }),
                            filepath: editor.filepath,
                            filename: editor.filename,
                            time: Date.now(),
                            nearby: nearby,
                        }))
                    } else {
                        webSocket.send(JSON.stringify({
                            type: 'relay',
                            to: teammate.email,
                            message: {
                                type: 'cursor-position',
                                line: cursor.line,
                                ch: cursor.ch,
                                index: editor.indexFromPos({
                                    line: cursor.line,
                                    ch: cursor.ch,
                                }),
                                filepath: editor.filepath,
                                filename: editor.filename,
                                time: Date.now(),
                                nearby: nearby,
                            },
                        }))
                    }
                }
            })
        })

        // editor.on('beforeChange', function(cm, change) {
        //     console.log('beforeChange', change)
        //     change.fromIndex = editor.indexFromPos(change.from)
        //     change.toIndex = editor.indexFromPos(change.to)
        // })
        
        // var revisionId = 0

        // editor.on('electricInput', function(cm, line) {
        //     console.log('electricInput', line)
        // })

        // editor.on('changes', function(cm, changes) {
        editor.on('change', function(cm, change) {
            if(editor.refreshing) return

            

            var localChanges = []
            // changes.forEach(function(change) {
                // console.log('change', change)
                change.originalFrom = change.from
                change.from = cm.indexFromPos(change.from)
                change.originalTo = change.to
                change.to = change.from + change.removed.join('\n').length
                
                change.beforeContents = editor.beforeContents
                change.beforeChecksum = editor.beforeChecksum

                change.contents = editor.getValue()
                change.checksum = crc32(change.contents.toString('binary'))

                // if(change.origin !== undefined && change.origin != '+remote') {
                if(change.origin != '+remote') {
                    localChanges.push(change)
                }
            // })
            
            if(localChanges.length > 0) {
                console.log('\n\n\n----------------------------------------\nEDIT MADE BY YOU\n')

                markTimeline('#000')
                
                // console.log('changes', changes)
                // console.log('changes.length', changes.length)
                localChanges.forEach(function(change, i) {
                    console.log('\n-----------\nCHANGE ' + i)
                    console.log('change.origin', change.origin)
                    console.log('change.from', change.from)
                    console.log('change.to', change.to)
                    console.log('change.removed', JSON.stringify(change.removed))
                    console.log('change.text', JSON.stringify(change.text))
                })

                console.log('\nbefore change contents:', editor.beforeChecksum)
                console.log(editor.beforeContents)
                console.log('---------------------')
                pprint(editor.beforeContents)

                var afterContents = editor.getValue()
                var checksum = crc32(afterContents.toString('binary'))

                console.log('\nafter change contents:', checksum)
                console.log(afterContents)
                console.log('---------------------\n')
                pprint(afterContents)


                editor.revisionId++
                // editor.unconfirmedChanges++

                // console.log('before change history:', JSON.stringify(editor.history, null, 2))
                
                // Add entry to checksum table
                editor.checksumTable[crc32(editor.getValue().toString('binary'))] = {
                    index: editor.history.length,
                    contents: editor.getValue(),
                    historyEntry: localChanges[0],
                }

                editor.history = editor.history.concat(localChanges)
                console.log('after change history:', JSON.stringify(editor.history, null, 2))
                console.log('after checksumTable:', editor.checksumTable)

                console.log('revisionId send', editor.revisionId)

                var messageId = Math.random().toString()

                // console.log('localChanges', localChanges)

                webSocket.send(JSON.stringify({
                    type: 'editor-changes',
                    filepath: editor.filepath,
                    filename: editor.filename,
                    changes: localChanges,
                    time: Date.now(),
                    contents: afterContents,
                    checksum: checksum,
                    beforeContents: editor.beforeContents,
                    beforeChecksum: editor.beforeChecksum,
                    revisionId: editor.revisionId,
                    id: messageId,
                }))
                
                Object.values(team.members).forEach(function(teammate) {
                    if(teammate.online) {
                        // if(teammate.dataChannel && teammate.dataChannel.readyState == 'open') {
                        //     teammate.dataChannel.send(JSON.stringify({
                        //         type: 'editor-changes',
                        //         filepath: editor.filepath,
                        //         filename: editor.filename,
                        //         changes: localChanges,
                        //         time: Date.now(),
                        //         contents: afterContents,
                        //         checksum: checksum,
                        //         beforeContents: editor.beforeContents,
                        //         beforeChecksum: editor.beforeChecksum,
                        //         revisionId: editor.revisionId,
                        //         id: messageId,
                        //     }))
                        // } else {
                            webSocket.send(JSON.stringify({
                                type: 'relay',
                                to: teammate.email,
                                message: {
                                    type: 'editor-changes',
                                    filepath: editor.filepath,
                                    filename: editor.filename,
                                    changes: localChanges,
                                    time: Date.now(),
                                    contents: afterContents,
                                    checksum: checksum,
                                    beforeContents: editor.beforeContents,
                                    beforeChecksum: editor.beforeChecksum,
                                    revisionId: editor.revisionId,
                                    id: messageId,
                                }
                            }))
                        // }
                    }
                })
                
                editor.beforeChecksum = checksum
                editor.beforeContents = afterContents
            }
            
        }) 

        return editor
    }

    function getChangeSize(change) {
        var size = {
            lines: 0,
            chars: 0,
        }

        size.lines -= change.removed.length - 1
        
        change.removed.forEach(function(str) {
            size.chars -= str.length
        })

        size.lines += change.text.length - 1

        change.text.forEach(function(str) {
            size.chars += str.length
        })

        console.log('size', size)
        return size
    }

    ///////////////
    // Filesystem

    function removeIndented(elm) {
        var l = Array.from(elm.parentElement.children)
        var i = l.indexOf(elm) + 1
        
        while(true) {
            if(i >= l.length) break
            
            var c = l[i]

            if(getIndentationLevel(c) > getIndentationLevel(elm)) {
                c.remove()
            }

            else {
                break
            }

            i += 1
        }

        function getIndentationLevel(element) {
            return element.textContent.length - element.textContent.trim().length
        }
    }

    function makeFolderClickable(elm, path, name) {
        var fullpath
        if(path) {
            fullpath = path + name + '/'
        } else {
            fullpath = '/'
        }

        elm.addEventListener('click', function(event) {
            if(fullpath == '/') return

            if(openFolders.includes(fullpath)) {
                // closeFolder
                openFolders.splice(openFolders.indexOf(fullpath), 1)
                elm.classList.remove('open')
                elm.textContent = elm.textContent.replace('▼', '▶')
                removeIndented(elm)
            }

            else {
                // openFolder
                openFolders.push(fullpath)
                elm.classList.add('open')
                elm.textContent = elm.textContent.replace('▶', '▼')
                addFolder(elm, elm.contents, fullpath, elm.indentationLevel + 1)
            }
        })

        elm.addEventListener('contextmenu', function(event) {
            event.preventDefault()
            // console.log('right click')

            var menu = document.querySelector('#context-menu')
            menu.innerHTML = ''
            menu.style.display = 'block'
            menu.style.left = (event.clientX + 5) + 'px'
            menu.style.top = (event.clientY + 5) + 'px'

            var p
            
            p = document.createElement('p')
            p.textContent = 'New File'
            menu.appendChild(p)

            p.addEventListener('click', function() {
                var f = document.createElement('form')
                
                var h2 = document.createElement('h2')
                h2.textContent = 'Create new file in'
                h2.style.marginBottom = '20px'
                
                var p = document.createElement('p')
                p.textContent = fullpath
                // p.style.margin = '50px'
                

                var input = document.createElement('input')
                input.setAttribute('type', 'text')
                
                var button = document.createElement('button')
                button.textContent = 'Create New File'

                var message = document.createElement('p')
                message.textContent = ''

                f.appendChild(h2)
                f.appendChild(p)
                f.appendChild(input)
                f.appendChild(button)
                f.appendChild(message)
                
                f.addEventListener('submit', function(event) {
                    sendNewFile(event)
                })
                
                openModal(f)

                function sendNewFile(event) {
                    event.preventDefault()

                    var filename = input.value

                    if(!filename) {
                        message.textContent = 'Filename cannot be empty.'
                        return false
                    }

                    if(filename.includes('/')) {
                        message.textContent = 'Filename cannot contain "/".'
                        return false
                    }

                    fetch('/api/newFile?path=' + encodeURIComponent(fullpath) + '&filename=' + encodeURIComponent(filename) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                    }).then(function(response) {
                        if(response.ok) {
                            updateFilesystem(function() {
                                closeModal()
                                var fileView = createFileView(filename, fullpath)
                                var icon = getIconFromFilename(filename)
                                // console.log(filename, fullpath)
                                var tab = addTab(icon + ' ' + filename, 'file:' + fullpath + filename, fileView)
                                switchTab(tab)
                            })
                        }

                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else if(response.status == 409) {
                            message.textContent = 'Cannot create file because it already exists.'
                        }

                        else {
                            message.textContent = 'Error: code ' + response.status
                        }
                    })

                    return false
                }

                input.focus()
            })

            p = document.createElement('p')
            p.textContent = 'Upload File'
            menu.appendChild(p)
            
            p.addEventListener('click', function() {
                var upload = document.createElement('input')
                upload.setAttribute('type', 'file')
                upload.style.display = 'none'
                document.body.appendChild(upload)

                upload.addEventListener('change', function() {
                    if(upload.files[0] === undefined) {
                        // message.textContent = 'Choose a file first.'
                        return
                    }

                    var filename = upload.files[0].name
                    
                    fetch('/api/uploadFile?path=' + encodeURIComponent(fullpath) + '&filename=' + encodeURIComponent(filename) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                        body: upload.files[0],
                    }).then(function(response) {
                        if(response.ok) {
                            // message.textContent = 'Upload complete.'
                            // console.log('File uploaded:', upload.files[0].name)
                            // location.reload() 
                        }

                        else if(response.status == 507) {
                            promptForPayment()
                        }

                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else {
                            // message.textContent = "There was an error. Please try again."
                        }
                    })
                })

                upload.click()
            })

            menu.appendChild(document.createElement('hr'))

            p = document.createElement('p')
            p.textContent = 'New Folder'
            menu.appendChild(p)

            p.addEventListener('click', function() {
                var f = document.createElement('form')
                
                var h2 = document.createElement('h2')
                h2.textContent = 'Create new folder in'
                h2.style.marginBottom = '20px'
                
                var p = document.createElement('p')
                p.textContent = fullpath

                var input = document.createElement('input')
                input.setAttribute('type', 'text')
                
                var button = document.createElement('button')
                button.textContent = 'Create New Folder'

                var message = document.createElement('p')
                message.textContent = ''

                f.appendChild(h2)
                f.appendChild(p)
                f.appendChild(input)
                f.appendChild(button)
                f.appendChild(message)
                
                f.addEventListener('submit', function(event) {
                    sendNewFolder(event)
                })
                
                openModal(f)

                function sendNewFolder(event) {
                    event.preventDefault()

                    var filename = input.value

                    if(!filename) {
                        message.textContent = 'Folder name cannot be empty.'
                        return false
                    }

                    if(filename.includes('/')) {
                        message.textContent = 'Folder name cannot contain "/".'
                        return false
                    }

                    fetch('/api/newFolder?path=' + encodeURIComponent(fullpath) + '&filename=' + encodeURIComponent(filename) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                    }).then(function(response) {
                        if(response.ok) {
                            closeModal()
                        }

                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else if(response.status == 409) {
                            message.textContent = 'Cannot create folder because it already exists.'
                        }

                        else {
                            message.textContent = 'Error: code ' + response.status
                        }
                    })

                    return false
                }

                input.focus()
            })

            p = document.createElement('p')
            p.textContent = 'Upload folder from zip'
            menu.appendChild(p)

            p.addEventListener('click', function() {
                var upload = document.createElement('input')
                upload.setAttribute('type', 'file')
                upload.style.display = 'none'
                document.body.appendChild(upload)

                upload.addEventListener('change', function() {
                    if(upload.files[0] === undefined) {
                        message.textContent = 'Choose a file first.'
                        return
                    }
                    
                    if(upload.files[0].type != 'application/zip') {
                        message.textContent = 'Must be a zip file.'
                        return
                    }

                    // console.log('path', path, 'name', name)
                    
                    var fullpath
                    
                    if(path) {
                        fullpath = path + name + '/'
                    }
                    
                    else {
                        fullpath = '/'
                    }

                    // console.log('fullpath', fullpath)

                    // message.textContent = 'Uploading...'
                    fetch('/api/uploadFolder?path=' + encodeURIComponent(fullpath) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                        body: upload.files[0],
                    }).then(function(response) {
                        if(response.ok) {
                            // message.textContent = 'Upload complete.'
                            // console.log('File uploaded:', upload.files[0].name)
                            // location.reload() 
                        }
                        
                        else if(response.status == 507) {
                            promptForPayment()
                        }
                        
                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else {
                            // message.textContent = "There was an error. Please try again."
                        }
                    })
                })

                upload.click()
            })

            // p = document.createElement('p')
            // p.textContent = 'Upload folder from git'
            // menu.appendChild(p)

            menu.appendChild(document.createElement('hr'))

            p = document.createElement('p')
            p.textContent = 'Cut'
            if(fullpath == '/') {
                p.style.color = '#888'
                p.classList.add('disabled')
            }
            menu.appendChild(p)

            p.addEventListener('click', function() {
                clipboard = {
                    type: 'folder',
                    action: 'cut',
                    path: path,
                    name: name,
                }
            })

            p = document.createElement('p')
            p.textContent = 'Copy'
            if(fullpath == '/') {
                p.style.color = '#888'
                p.classList.add('disabled')
            }
            menu.appendChild(p)

            p.addEventListener('click', function() {
                clipboard = {
                    type: 'folder',
                    action: 'copy',
                    path: path,
                    name: name,
                }
            })

            p = document.createElement('p')
            p.textContent = 'Paste'
            if(!clipboard) {
                p.style.color = '#888'
                p.classList.add('disabled')
            }
            menu.appendChild(p)

            p.addEventListener('click', function() {
                if(!clipboard) return

                // console.log('clipboard', clipboard)

                if(clipboard.action == 'cut') {
                    fetch('/api/move?newPath=' + encodeURIComponent(fullpath) + '&oldPath=' + encodeURIComponent(clipboard.path) + '&filename=' + encodeURIComponent(clipboard.name) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                    }).then(function(response) {
                        if(response.ok) {
                            toast('Moved <b>' + clipboard.path + clipboard.name + '</b> to <b>' + fullpath + '</b>')
                            clipboard = null
                        }
                                                
                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else if(response.status == 409) {
                            toast('Could not move <b>' + clipboard.path + clipboard.name + '</b> to <b>' + fullpath + '</b> because it already exists.')
                        }
                        
                        else {
                            toast('Could not move <b>' + clipboard.path + clipboard.name + '</b> to <b>' + fullpath + '</b> because of error: <b>' + response.status + '</b>')
                        }
                    })
                }
                
                if(clipboard.action == 'copy' && clipboard.type == 'file') {
                    fetch('/api/copyFile?newPath=' + encodeURIComponent(fullpath) + '&oldPath=' + encodeURIComponent(clipboard.path) + '&filename=' + encodeURIComponent(clipboard.name) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                    }).then(function(response) {
                        if(response.ok) {
                            toast('Copied <b>' + clipboard.path + clipboard.name + '</b> to <b>' + fullpath + '</b>')
                        }
                                                
                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else if(response.status == 409) {
                            toast('Could not copy <b>' + clipboard.path + clipboard.name + '</b> to <b>' + fullpath + '</b> because it already exists.')
                        }
                        
                        else {
                            toast('Could not copy <b>' + clipboard.path + clipboard.name + '</b> to <b>' + fullpath + '</b> because of error: <b>' + response.status + '</b>')
                        }
                    })
                }

                if(clipboard.action == 'copy' && clipboard.type == 'folder') {
                    fetch('/api/copyFolder?newPath=' + encodeURIComponent(fullpath) + '&oldPath=' + encodeURIComponent(clipboard.path) + '&filename=' + encodeURIComponent(clipboard.name) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                    }).then(function(response) {
                        if(response.ok) {
                            toast('Copied <b>' + clipboard.path + clipboard.name + '</b> to <b>' + fullpath + '</b>')
                        }
                                                
                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else if(response.status == 409) {
                            toast('Could not copy <b>' + clipboard.path + clipboard.name + '</b> to <b>' + fullpath + '</b> because it already exists.')
                        }
                        
                        else {
                            toast('Could not copy <b>' + clipboard.path + clipboard.name + '</b> to <b>' + fullpath + '</b> because of error: <b>' + response.status + '</b>')
                        }
                    })
                }
            })

            menu.appendChild(document.createElement('hr'))
            
            p = document.createElement('p')
            p.textContent = 'Rename'
            if(fullpath == '/') {
                p.style.color = '#888'
                p.classList.add('disabled')
            }
            menu.appendChild(p)



            p.addEventListener('click', function() {
                var f = document.createElement('form')
                
                var h2 = document.createElement('h2')
                h2.textContent = 'Rename folder in'
                h2.style.marginBottom = '20px'
                
                var p = document.createElement('p')
                p.textContent = path

                var input = document.createElement('input')
                input.setAttribute('type', 'text')
                input.value = name
                
                var button = document.createElement('button')
                button.textContent = 'Rename'

                var message = document.createElement('p')
                message.textContent = ''

                f.appendChild(h2)
                f.appendChild(p)
                f.appendChild(input)
                f.appendChild(button)
                f.appendChild(message)
                
                f.addEventListener('submit', function(event) {
                    renameFile(event)
                })
                
                openModal(f)

                function renameFile(event) {
                    event.preventDefault()

                    var filename = input.value

                    fetch('/api/rename?path=' + encodeURIComponent(path) + '&newFilename=' + encodeURIComponent(filename) + '&oldFilename=' + encodeURIComponent(name) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                    }).then(function(response) {
                        if(response.ok) {
                            closeModal()
                        }

                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else if(response.status == 409) {
                            message.textContent = 'Cannot create folder because it already exists.'
                        }

                        else {
                            message.textContent = 'Error: code ' + response.status
                        }
                    })

                    return false
                }

                input.focus()
            })
          

            
            p = document.createElement('p')
            p.textContent = 'Delete'
            if(fullpath == '/') {
                p.style.color = '#888'
                p.classList.add('disabled')
            }
            menu.appendChild(p)


            p.addEventListener('click', function() {
                var f = document.createElement('form')
                
                var h2 = document.createElement('h2')
                h2.textContent = 'Confirm deletion of'
                h2.style.marginBottom = '20px'
                
                var p = document.createElement('p')
                p.textContent = path + name

                var button = document.createElement('button')
                button.textContent = 'Delete'

                var message = document.createElement('p')
                message.textContent = ''

                f.appendChild(h2)
                f.appendChild(p)
                f.appendChild(button)
                f.appendChild(message)
                
                f.addEventListener('submit', function(event) {
                    deleteFolder(event)
                })
                
                openModal(f)

                function deleteFolder(event) {
                    event.preventDefault()

                    fetch('/api/deleteFolder?path=' + encodeURIComponent(path) + '&filename=' + encodeURIComponent(name) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                    }).then(function (response) {
                        if(response.ok) {
                            closeModal()
                        }

                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else {
                            message.textContent = 'Error: code ' + response.status
                        }
                    })

                    return false
                }
            })

            
            menu.appendChild(document.createElement('hr'))
            
            p = document.createElement('p')
            p.textContent = 'Download as zip'
            if(elm.emptyFolder) {
                p.style.color = '#888'
                p.classList.add('disabled')
            }
            menu.appendChild(p)
            
            p.addEventListener('click', function() {
                fetch('/api/downloadFolder?path=' + encodeURIComponent(path) + '&filename=' + encodeURIComponent(name) + '&team=' + encodeURIComponent(team.teamId), {
                    method: 'GET',
                    headers: {
                        Authorization: 'Bearer ' + localStorage.sessionId,
                    },
                })
                .then(function (response) {
                    if(response.ok) {
                        return response.blob()
                    }

                    else if(response.status == 401) {
                        location.href = '/'
                    }
                })
                .then(function(blob) {
                    var url = URL.createObjectURL(blob)
                    var a = document.createElement('a')
                    a.href = url
                    if(path) {
                        a.download = name + '.zip'
                    } else {
                        a.download = 'team-' + shortTeamId + '.zip'
                    }
                    document.body.appendChild(a)
                    a.click()    
                    a.remove()
                })
            })

            var offscreenAmount = (menu.clientHeight + event.clientY + 15) - window.innerHeight
            if(offscreenAmount > 0) {
                menu.style.top = (event.clientY + 5 - offscreenAmount) + 'px'
            }

            document.body.addEventListener('click', function(event) {
                if(event.target != menu) {
                    menu.innerHTML = ''
                    menu.style.display = 'none'
                }
            })

        })
    }

    function makeFileClickable(elm, path, name) {
        elm.addEventListener('click', function() {
            // var fileView = createFileView(name, path)
            // var fileView = createFileEditorView(name, path)
            var fileView = createFileView(name, path)
            var icon = getIconFromFilename(name)
            var tab = addTab(icon + ' ' + name, 'file:' + path + name, fileView)

            switchTab(tab)
        })


        elm.addEventListener('contextmenu', function(event) {
            event.preventDefault()

            var menu = document.querySelector('#context-menu')
            menu.innerHTML = ''
            menu.style.display = 'block'
            menu.style.left = (event.clientX + 5) + 'px'
            menu.style.top = (event.clientY + 5) + 'px'
            
            var p
            
            p = document.createElement('p')
            p.textContent = 'Replace'
            menu.appendChild(p)
            
            p.addEventListener('click', function() {
                var upload = document.createElement('input')
                upload.setAttribute('type', 'file')
                upload.style.display = 'none'
                document.body.appendChild(upload)

                upload.addEventListener('change', function() {
                    if(upload.files[0] === undefined) {
                        message.textContent = 'Choose a file first.'
                        return
                    }

                    // console.log('path', path, 'name', name)

                    // message.textContent = 'Uploading...'
                    fetch('/api/uploadFile?path=' + encodeURIComponent(path) + '&filename=' + encodeURIComponent(name) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                        body: upload.files[0],
                    }).then(function(response) {
                        if(response.ok) {
                            // message.textContent = 'Upload complete.'
                            // console.log('File uploaded:', upload.files[0].name)
                            // location.reload() 
                        }

                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else {
                            // message.textContent = "There was an error. Please try again."
                        }
                    })
                })

                upload.click()
            })

            menu.appendChild(document.createElement('hr'))
            
            p = document.createElement('p')
            p.textContent = 'Cut'
            menu.appendChild(p)
            
            p.addEventListener('click', function() {
                clipboard = {
                    type: 'file',
                    action: 'cut',
                    path: path,
                    name: name,
                }
            })

            p = document.createElement('p')
            p.textContent = 'Copy'
            menu.appendChild(p)
            
            p.addEventListener('click', function() {
                clipboard = {
                    type: 'file',
                    action: 'copy',
                    path: path,
                    name: name,
                }
            })

            menu.appendChild(document.createElement('hr'))
            
            p = document.createElement('p')
            p.textContent = 'Rename'
            menu.appendChild(p)


            p.addEventListener('click', function() {
                var f = document.createElement('form')
                
                var h2 = document.createElement('h2')
                h2.textContent = 'Rename file in'
                h2.style.marginBottom = '20px'
                
                var p = document.createElement('p')
                p.textContent = path

                var input = document.createElement('input')
                input.setAttribute('type', 'text')
                input.value = name
                
                var button = document.createElement('button')
                button.textContent = 'Rename'

                var message = document.createElement('p')
                message.textContent = ''

                f.appendChild(h2)
                f.appendChild(p)
                f.appendChild(input)
                f.appendChild(button)
                f.appendChild(message)
                
                f.addEventListener('submit', function(event) {
                    renameFile(event)
                })
                
                openModal(f)

                function renameFile(event) {
                    event.preventDefault()

                    var filename = input.value

                    fetch('/api/rename?path=' + encodeURIComponent(path) + '&newFilename=' + encodeURIComponent(filename) + '&oldFilename=' + encodeURIComponent(name) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                    }).then(function(response) {
                        if(response.ok) {
                            closeModal()
                        }

                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else if(response.status == 409) {
                            message.textContent = 'Cannot create file because it already exists.'
                        }

                        else {
                            message.textContent = 'Error: code ' + response.status
                        }
                    })

                    return false
                }

                input.focus()
            })
          


            p = document.createElement('p')
            p.textContent = 'Delete'
            menu.appendChild(p)

            p.addEventListener('click', function() {
                var f = document.createElement('form')
                
                var h2 = document.createElement('h2')
                h2.textContent = 'Confirm deletion of'
                h2.style.marginBottom = '20px'
                
                var p = document.createElement('p')
                p.textContent = path + name

                var button = document.createElement('button')
                button.textContent = 'Delete'

                var message = document.createElement('p')
                message.textContent = ''

                f.appendChild(h2)
                f.appendChild(p)
                f.appendChild(button)
                f.appendChild(message)
                
                f.addEventListener('submit', function(event) {
                    deleteFile(event)
                })
                
                openModal(f)

                function deleteFile(event) {
                    event.preventDefault()

                    fetch('/api/deleteFile?path=' + encodeURIComponent(path) + '&filename=' + encodeURIComponent(name) + '&team=' + encodeURIComponent(team.teamId), {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + localStorage.sessionId,
                        },
                    }).then(function (response) {
                        if(response.ok) {
                            closeModal()
                        }

                        else if(response.status == 401) {
                            location.href = '/'
                        }

                        else {
                            message.textContent = 'Error: code ' + response.status
                        }
                    })

                    return false
                }
            })

            menu.appendChild(document.createElement('hr'))
            
            p = document.createElement('p')
            p.textContent = 'Download'
            menu.appendChild(p)

            p.addEventListener('click', function() {
                fetch('/api/downloadFile?path=' + encodeURIComponent(path) + '&filename=' + encodeURIComponent(name) + '&team=' + encodeURIComponent(team.teamId), {
                    method: 'GET',
                    headers: {
                        Authorization: 'Bearer ' + localStorage.sessionId,
                    },
                })
                .then(function (response) {
                    if(response.ok) {
                        return response.blob()
                    }

                    else if(response.status == 401) {
                        location.href = '/'
                    }
                })
                .then(function(blob) {
                    var url = URL.createObjectURL(blob)
                    var a = document.createElement('a')
                    a.href = url
                    a.download = name
                    document.body.appendChild(a)
                    a.click()    
                    a.remove()
                })
            })

            var offscreenAmount = (menu.clientHeight + event.clientY + 15) - window.innerHeight
            if(offscreenAmount > 0) {
                menu.style.top = (event.clientY + 5 - offscreenAmount) + 'px'
            }

            document.body.addEventListener('click', function(event) {
                if(event.target != menu) {
                    menu.innerHTML = ''
                    menu.style.display = 'none'
                }
            })

        })
    }

    function closeTab(tab) {
        if(tab) {
            var selected = false
            if(Array.from(tab.classList).includes('selected')) {
                selected = true
            }
            
            tab.element.remove()
            tab.remove()

            if(document.querySelector('#tabs').children.length > 0) {
                if(selected) {
                    switchTab(document.querySelector('#tabs').children[0])    
                }
            } else {
                document.querySelector('#doc-header > h2').textContent = ''
                document.querySelector('#doc-header > div').innerHTML = ''
            }
        }

        updateTabCount()
    }

    function addTab(name, key, element, replace) {
        var alreadyOpen = false

        var tabs = document.querySelector('#tabs')
        tabs.querySelectorAll('div').forEach(function(tab) {
            if(tab.key == key) {
                alreadyOpen = tab
            }
        })

        if(alreadyOpen) {
            return alreadyOpen
        }

        var tab = document.createElement('div')
        
        var span = document.createElement('span')
        span.textContent = name

        var closeButton = document.createElement('a')
        closeButton.textContent = 'x'
        closeButton.style.color = '#888'

        closeButton.addEventListener('click', function(event) {
            event.preventDefault()
            event.stopPropagation()

            closeTab(tab)

            return false
        })

        
        tab.appendChild(span)
        tab.appendChild(closeButton)

        tab.key = key
        tab.name = name

        var tabs = document.querySelector('#tabs')
        // tabs.appendChild(tab)
        tabs.insertBefore(tab, tabs.firstChild)

        tab.addEventListener('click', function() {
            switchTab(tab)
        })

        tab.element = element

        var mainView = document.querySelector('#main-view')
        tab.element.style.display = 'none'
        mainView.appendChild(tab.element)

        updateTabCount()

        return tab
    }

    function updateTabCount() {
        var tabs = document.querySelector('#tabs')
        var w = document.querySelector('#doc-header').clientWidth
        // var tab = tabs.querySelector('div')

        if(tabs.children.length * 222 > w) {
            // var numOffscreenElements = Math.ceil((tabs.scrollWidth - tabs.clientWidth) / tab.offsetWidth)
            // document.querySelector('#more-tabs span').textContent = numOffscreenElements.toString()
            // document.querySelector('#more-tabs').style.display = 'block'

            
            tabs.childNodes.forEach(function(tab) {
                tab.childNodes[0].style.width = (w / tabs.children.length) - 22.2 + 'px'
            })
            // tabs.classList.add('scaled')
        }
        
        else {

            tabs.childNodes.forEach(function(tab) {
                tab.childNodes[0].style.width = '222px'
                // tab.childNodes[0].style.width = (w / tabs.children.length) - 22 + 'px'
            })
            // document.querySelector('#more-tabs').style.display = 'none'
            // tabs.classList.remove('scaled')
        }
    }


    function switchTab(tab) {
        var tabs = document.querySelector('#tabs')
        tabs.querySelectorAll('div').forEach(function(t) {
            t.classList.remove('selected')
            // t.element.style.opacity = '0'
            // t.element.style.zIndex = '-1'
            t.element.style.display = 'none'
        })
        
        tab.classList.add('selected')
        tab.element.style.display = 'block'
        // tab.element.style.zIndex = '1'
        // tab.element.style.opacity = '1'

        if(tab.element.querySelector('.CodeMirror')) {
            tab.element.querySelector('.CodeMirror').CodeMirror.refresh()
        }

        activeTab = tab
        
        document.querySelector('#doc-header > h2').textContent = ''
        document.querySelector('#doc-header > div').innerHTML = ''

        if(tab.key.startsWith('file:')) {
            document.querySelector('#doc-header > h2').textContent = getIconFromFilename(tab.key) + ' ' + tab.key.slice(5)
        }
        
        else {
            document.querySelector('#doc-header > h2').textContent = tab.name
        }

        document.querySelector('#doc-header > h2').textContent = document.querySelector('#doc-header > h2').textContent.slice(-85)
        
        
        if(tab.key.startsWith('file:') && tab.name[0] == '≡') {
            // document.querySelector('#doc-header > div').innerHTML = '<button class="edit">Edit (Ctrl-S)</button><button class="push">Push (Ctrl-P)</button>'
            document.querySelector('#doc-header > div').innerHTML = '<button class="edit">Edit</button>'
            
            var editButton = document.querySelector('#doc-header > div button.edit')
            
            if(tab.element.querySelector('.CodeMirror') && !tab.element.querySelector('.CodeMirror').CodeMirror.isReadOnly()) {
                editButton.textContent = 'Stop Editing'
            }
            
            /*
            var pushButton = document.querySelector('#doc-header > div button.push')
            pushButton.addEventListener('click', function() {
                var codemirrorElement = tab.element.querySelector('.CodeMirror')
                var cm = codemirrorElement.CodeMirror
                if(!codemirrorElement) {
                    toast("Can't push. No editor.")
                    return
                }
                
                fetch('/api/pushFile?path=' + encodeURIComponent(tab.key.slice(5)) + '&team=' + encodeURIComponent(team.teamId), {
                    method: 'POST',
                    headers: {
                        Authorization: 'Bearer ' + localStorage.sessionId,
                    },
                    body: cm.getValue(),
                }).then(function(response) {
                    if(response.ok) {
                        // message.textContent = 'Upload complete.'
                        // console.log('File pushed.')
                        toast('<b>' + tab.key.slice(5).split('/').slice(-1)[0] + '</b> written to remote filesystem.')
                        // location.reload() 
                    }

                    else if(response.status == 401) {
                        location.href = '/'
                    }

                    else {
                        // message.textContent = "There was an error. Please try again."
                    }
                })
            })
            */

            editButton.addEventListener('click', function() {
                var cm = tab.element.querySelector('.CodeMirror').CodeMirror
                
                if(cm.isReadOnly()) {
                    editButton.textContent = 'Stop Editing'
                    tab.element.querySelector('.CodeMirror').style.backgroundColor = '#222'
                    // document.querySelector('#doc-header > h2').textContent = getIconFromFilename(tab.key) + ' ' + tab.key.slice(5)
                    cm.setOption('readOnly', false)

                    demoCanvas.style.display = 'block'
                }
                
                else {
                    // editButton.textContent = 'Edit (Ctrl-S)'
                    editButton.textContent = 'Edit'
                    tab.element.querySelector('.CodeMirror').style.backgroundColor = '#444'
                    // document.querySelector('#doc-header > h2').textContent = getIconFromFilename(tab.key) + ' ' + tab.key.slice(5) + '(read only)'
                    cm.setOption('readOnly', true)
                }
            })
        }
        
        // var name = tab.key
        // if(tab.key.startsWith('file:') && name.slice(-5).toLowerCase() == '.jpeg' || name.slice(-4).toLowerCase() == '.jpg' || name.slice(-4).toLowerCase() == '.png' || name.slice(-4).toLowerCase() == '.gif') {
        //     document.querySelector('#doc-header > div').innerHTML = '<button class="push">Send to server/desktop</button>'
            
        //     var pushButton = document.querySelector('#doc-header > div button.push')
        //     pushButton.addEventListener('click', function() { 
        //         fetch('/api/pushFile?path=' + encodeURIComponent(tab.key.slice(5)) + '&team=' + encodeURIComponent(team.teamId), {
        //             method: 'POST',
        //             headers: {
        //                 Authorization: 'Bearer ' + localStorage.sessionId,
        //             },
        //             body: tab.element.querySelector('img'),
        //         }).then(function(response) {
        //             if(response.ok) {
        //                 // message.textContent = 'Upload complete.'
        //                 console.log('File pushed.')
        //                 toast('<b>' + tab.key.slice(5).split('/').slice(-1)[0] + '</b> written to remote filesystem.')
        //                 // location.reload() 
        //             }

        //             else if(response.status == 401) {
        //                 location.href = '/'
        //             }

        //             else {
        //                 // message.textContent = "There was an error. Please try again."
        //             }
        //         })
        //     })
            
        
        webSocket.send(JSON.stringify({
            type: 'set-active-tab',
            tab: tab.name,
        }))
    }


    function getUser(done) {
        fetch('/api/user', {
            headers: {
                Authorization: 'Bearer ' + localStorage.sessionId,
            },
        }).then(function (response) {
            if (response.ok) {
                return response.json()
            }
            
            else {
                unAuthed()
            }
        }).then(function(data) {
            user = data
            team = getTeam(shortTeamId)

            if(!user) {
                return
            }
            
            console.log('user:', user)
            
            done()
        })
    }

    function unAuthed() {
        location.href = '/'
        // document.querySelector('header [name="email"]').textContent = 'You are not logged in.'
    }

    function connect() {
        console.log('connect')

        var statusElement = document.querySelector('#status-bar')
        statusElement.textContent = 'Connecting to server...'

        var webSocketProtocol = 'wss:'
        if(location.protocol == 'http:') {
            webSocketProtocol = 'ws:'
        } 

        webSocket = new WebSocket(webSocketProtocol + '//' + location.host)
        
        webSocket.addEventListener('open', function (event) {
            statusElement.textContent = 'Connected to server. Measuring latency...'

            var message = {
                type: 'authorization',
                authorization: 'Bearer ' + localStorage.sessionId,
                team: shortTeamId, 
            }

            webSocket.send(JSON.stringify(message))
        })

        webSocket.addEventListener('message', function (event) {
            var message = JSON.parse(event.data)
            // console.log(message)

            if(message.type == 'pong') {
                var latency = Math.ceil((Date.now() - message.pingTime))
                // console.log('Latency:', latency + 'ms')
                document.querySelector('#status-bar').textContent = 'Connected to server with ' + latency + 'ms latency'
            }

            if(message.type == 'authenticated') {
                message.onlineTeam.forEach(function(email) {
                    if(email == user.email) return

                    // console.log(team)
                    team.members[email].online = true
                    if(!team.members[email].peerElement) {
                        team.members[email].peerElement = addPeerElement(email)
                    }

                    if(localVideoStream) {
                        // console.log('b')
                        team.members[email].peerConnections.toVideo = call(email, 'toVideo')
                    }
                    if(localScreenStream) {
                        team.members[email].peerConnections.toScreen = call(email, 'toScreen')
                    }
                })

                updateOfflineList()
                updateInvitedList()
                updateFilesystem()
            }

            if(message.type == 'filesystem-changed') {
                updateFilesystem()
            }

            // if(message.type == 'file-changed') {
            //     patchFile(message.path, message.filename, message.change)
            // }

            if(message.type == 'change-confirmation') {
                // if(message.from == user.email) {
                //     editor.unconfirmedChanges--
                // }

                if(message.success && message.reason == 'checksum-match') {
                    markTimeline('#2f2')
                }

                else if(message.success && message.reason == 'checksum-mismatch') {
                    markTimeline('#ff2')
                }
                
                else if(!message.success) {
                    console.log(message.reason)
                    // console.log(message.reason, message.contents)
                    markTimeline('#f22')
                }

                else {
                    console.log(message.reason)
                    // console.log(message.reason, message.contents)
                    markTimeline('#f2f')
                }

                var editor = null
                var editorTab = null

                var tabs = document.querySelector('#tabs')
                tabs.querySelectorAll('div').forEach(function(tab) {
                    if(tab.key == 'file:' + message.path + message.filename && tab.element.querySelector(".CodeMirror")) {
                        editorTab = tab
                        editor = tab.element.querySelector(".CodeMirror").CodeMirror
                    }
                })

                if(!editor) return

                if(!message.success && message.reason == 'checksum') {
                    // (message.from == user.email || editor.unconfirmedChanges <= 0)) {
                    // closeTab(editorTab)
                    // editor.refreshing = true
                    // var cursor = editor.getCursor()
                    // editor.setValue(message.contents)
                    // editor.setCursor(cursor)
                    // editor.refreshing = false
                }
            }

            if(message.type == 'team-changed') {
                getUser(function() {
                    updateOfflineList()
                    updateInvitedList()
                })
            }

            if(message.type == 'set-active-tab') {
                // console.log('set-active-tab', message)
                team.members[message.email].activeTabName = message.tab 
            }
            
            if(message.type == 'set-position') {
                // console.log('set-position', message)
                team.members[message.email].position = {
                    line: message.line,
                    ch: message.ch,
                }
            }

            if(message.type == 'relay') {
                handlePeerMessage(message.message, null, message.from)
            }

            // if(message.type == 'dm') {
            //     var link = sanitizeHTML(message.link)
            //     toast('<b>' + sanitizeHTML(message.from) + '</b>: ' + sanitizeHTML(message.message) + ' <a target="_blank" href="' + link + '">' + link + '</a>')
            // }

            if(message.type == 'joined') {
                var email = message.email
                
                team.members[email].online = true  

                if(!team.members[email].peerElement) {
                    team.members[email].peerElement = addPeerElement(email)
                }

                team.members[email].peerConnections.data = call(email, 'data')

                if(localVideoStream) {
                    // if(team.members[email].justCalled === undefined || Date.now() - team.members[email].justCalled > 5000) {
                        // console.log('c')
                        // team.members[email].justCalled = Date.now()
                        team.members[email].peerConnections.toVideo = call(email, 'toVideo')
                    // }
                }
                if(localScreenStream) {
                    team.members[email].peerConnections.toScreen = call(email, 'toScreen')
                }

                if(activeTab) {
                    webSocket.send(JSON.stringify({
                        type: 'set-active-tab',
                        tab: activeTab.name,
                    }))                
                }
                
                updateOfflineList()
            }
            
            if(message.type == 'left') {
                var email = message.email
                console.log(email, 'left')
                team.members[email].online = false

                if(team.members[email].peerElement) {
                    var cameraElement = team.members[email].peerElement.querySelector('[name="camera"]')
                    if(cameraElement) {
                        closeTab(cameraElement.mainVideoTab)
                    }
                    
                    var screenElement = team.members[email].peerElement.querySelector('[name="screen"]')
                    if(screenElement) {
                        closeTab(screenElement.mainVideoTab)
                    }

                    team.members[email].peerElement.remove()
                    delete team.members[email].peerElement
                }

                team.members[email].peerConnections = {}
                delete team.members[email].dataChannel

                updateOfflineList()
            }

            else if(message.type == 'iceCandidate') {
                // console.log('received iceCandidate', message.candidate)
                var candidate = new RTCIceCandidate(message.candidate)

                var peer = team.members[message.from]
                // console.log('peer', peer)
                // console.log('peerConnection', peer.peerConnections[message.channel])


                if(peer.peerConnections[message.channel]) {
                    var peerConnection = peer.peerConnections[message.channel]

                    function retry() {
                        if(peerConnection.q) {
                            if(peer.peerConnections[message.channel] && peer.peerConnections[message.channel].remoteDescription) {
                                peerConnection.q.forEach(function(item) {
                                    peerConnection.addIceCandidate(item)

                                    // console.log('commited iceCandiate from queue', item)
                                })
                                
                                peerConnection.q = []
                            }

                            else {
                                setTimeout(function() {
                                    retry()
                                }, 1000)    
                            }
                        }
                    }
                    
                    // console.log('remoteDescription', peer.peerConnections[message.channel].remoteDescription)
                    if(!peer.peerConnections[message.channel].remoteDescription) {
                        if(!peerConnection.q) {
                            peerConnection.q = []
                        }

                        // console.log('iceCandidate pushed to queue')
                        peerConnection.q.push(candidate)
                        // console.log('got ice message too early: no remoteDescription')

                        setTimeout(function() {
                            retry()
                        }, 1000)
                    }
                    
                    else {
                        retry()
                        peerConnection.addIceCandidate(candidate)
                        // console.log('commited iceCandiate immediately', candidate)
                    }
                }
                
                else {
                    // console.log('got ice message too early: no peerConnection')
                }
            }
            
            else if(message.type == 'answer') {
                var peer = team.members[message.from]
                var sessionDescription = new RTCSessionDescription(message.answer)
                var peerConnection = peer.peerConnections[message.channel]
                peerConnection.setRemoteDescription(sessionDescription)
            }

            else if(message.type == 'precall') {
                // console.log('received precall', message.from, message.channel)
                var toEmail = message.from
                var peer = team.members[message.from]
                
                delete peer.peerConnections[message.channel]
            }
            
            else if(message.type == 'offer') {
                var toEmail = message.from
                var peer = team.members[message.from]
                
                var peerConnection = createPeerConnection(toEmail, message.channel)
                peer.peerConnections[message.channel] = peerConnection

                var sessionDescription = new RTCSessionDescription(message.offer)

                peerConnection.setRemoteDescription(sessionDescription)
                .then(function() {
                    return peerConnection.createAnswer()
                })
                .then(function(answer) {
                    // console.log('answer', toEmail, answer)  
                    return peerConnection.setLocalDescription(answer)
                })
                .then(function() {
                    webSocket.send(JSON.stringify({
                        type: 'answer',
                        answer: peerConnection.localDescription,
                        to: toEmail,
                        from: yourEmail,
                        channel: reverseChannel(message.channel),
                    }))
                })
            }
        })

        webSocket.addEventListener('error', function (event) {
            statusElement.textContent = 'Disconnected. Trying to reconnect...'
            console.log('webSocket error:', event)
            closeWebSocket()
        })
        
        webSocket.addEventListener('close', function (event) {
            statusElement.textContent = 'Disconnected. Trying to reconnect...'
            console.log('webSocket closed:', event)
            closeWebSocket()
        })
        
        function closeWebSocket() {
            Object.values(team.members).forEach(function(peer) {
                if(peer.peerElement) {
                        peer.peerElement.remove()
                    delete peer.peerElement
                }
                
                peer.online = false
                
                peer.peerConnections = {}
                delete peer.dataChannel
            })
            
            updateOfflineList()
        }
    }

    function shareVideo() {
        navigator.mediaDevices.getUserMedia({
            audio: true,
            // audio: {
            //     autoGainControl: true,
            //     echoCancellation: true,
            //     noiseSuppression: true,
            // },
            // video:  true,
            video: {
                width: 320,
                height: 240,
            },
        }).then(function(localStream) {
            localVideoStream = localStream

            // document.querySelector('canvas.audio').style.display = 'block'
            setupAudio(localStream)
            // processAudioFrame()

            var tabName = 'You'

            var localVideo = document.querySelector('video[name="local-video"]')
            localVideo.addEventListener('click', function() {
                var video
                if(!localVideo.mainVideo) {
                    video = document.createElement('video')
                    video.autoplay = true
                    video.muted = true
                    // video.controls = true
                    localVideo.mainVideo = video
                } else {
                    video = localVideo.mainVideo
                }

                var tab = addTab(tabName, 'stream:camera:' + user.email, video)
                // updateTab(tabName, video)
                switchTab(tab)

                video.srcObject = localStream
            })

            localVideo.srcObject = localStream

            if(localVideo.mainVideo) {
                localVideo.mainVideo.srcObject = localStream
                // updateTab(tabName, video)
            }
            

            Object.values(team.members).forEach(function(peer) {
                if(peer.online) {
                    // console.log('a')
                    peer.peerConnections.toVideo = call(peer.email, 'toVideo')
                    peer.justCalled = Date.now()
                }
            })
        })
        .catch(function(error) {
            console.log(error)
        })
    }



    function shareScreen() {
        navigator.mediaDevices.getDisplayMedia({
            video: true,
            // frameRate: 5,
            // video: {
            //     width: 800,
            //     height: 450,
            // }
        })
        .then(function(localStream) {
            localScreenStream = localStream

            var tabName = 'You'

            var localScreen = document.querySelector('video[name="local-screen"]')        
            // var video
            // localScreen.addEventListener('click', function() {
            //     var video
            //     if(!localScreen.mainVideo) {
            //         video = document.createElement('video')
            //         video.autoplay = true
            //         video.muted = true
            //         video.controls = true
            //         localScreen.mainVideo = video
            //     } else {
            //         video = localScreen.mainVideo
            //     }

            //     var tab = addTab(tabName, 'stream:screen:' + user.email, video)
            //     // updateTab(tabName, video)
            //     switchTab(tab)

            //     video.srcObject = localStream
            // })
            
            localScreen.srcObject = localStream

            if(localScreen.mainVideo) {
                localScreen.mainVideo.srcObject = localStream
                // updateTab(tabName, video)
            }
            
            
            Object.values(team.members).forEach(function(peer) {
                if(peer.online) {
                    peer.peerConnections.toScreen = call(peer.email, 'toScreen')
                }
            })
        })
        .catch(function(error) {
            console.log(error)
        })
    }

    function reverseChannel(channel) {
        if(channel == 'toVideo') return 'fromVideo'
        if(channel == 'toScreen') return 'fromScreen'    
        if(channel == 'fromVideo') return 'toVideo'
        if(channel == 'fromScreen') return 'toScreen'    
        if(channel == 'data') return 'data'    
    }

    function addPeerElement(toEmail) {
        var peerElement

        var color

        if(assignedColors[toEmail] != undefined) {
            color = assignedColors[toEmail]
        }
        
        else {
            color = colors[colorCursor]
            assignedColors[toEmail] = color
        }

        colorCursor += 1
        if(colorCursor >= colors.length) {
            colorCursor = 0
        }

        peerElement = document.createElement('div')
        peerElement.style.borderRadius = '10px'
        peerElement.style.border = 'solid 5px ' + color
        peerElement.style.margin = '5px'
        peerElement.style.backgroundColor = '#fff'
        peerElement.color = color
        
        var p = document.createElement('p')
        p.textContent = toEmail
        p.style.margin = '0'
        p.style.paddingLeft = '3px'
        p.style.borderBottom = 'solid 1px #ddd'
        p.style.overflow = 'hidden'
        p.style.whiteSpace = 'nowrap'
        peerElement.appendChild(p)

        var l = document.createElement('p')
        l.textContent = ''
        l.style.margin = '0'
        l.style.paddingLeft = '3px'
        l.classList.add('latency')
        peerElement.appendChild(l)

        var peerVideoElement = document.createElement('video')
        peerVideoElement.setAttribute('name', 'camera')
        peerVideoElement.style.display = 'none'
        peerVideoElement.autoplay = true
        // peerVideoElement.controls = true
        if(!firstClick) {
            peerVideoElement.muted = true
        }
        peerElement.appendChild(peerVideoElement)
        
        peerVideoElement.addEventListener('click', function(event) {
            event.stopPropagation()
            var video = document.createElement('video')
            video.autoplay = true
            video.muted = true
            // video.controls = true
            peerVideoElement.mainVideo = video

            var tabName = toEmail + ' | Camera'
            var tab = addTab(tabName, 'stream:camera:' + toEmail, video)
            // updateTab(tabName, video)
            switchTab(tab)

            peerVideoElement.mainVideoTab = tab

            video.srcObject = peerVideoElement.srcObject
        })

        var peerScreenElement = document.createElement('video')
        peerScreenElement.setAttribute('name', 'screen')
        peerScreenElement.style.display = 'none'
        peerScreenElement.autoplay = true
        peerScreenElement.muted = true
        // peerScreenElement.controls = true
        peerElement.appendChild(peerScreenElement)

        peerScreenElement.addEventListener('click', function() {
            event.stopPropagation()
            var video = document.createElement('video')
            video.autoplay = true
            video.muted = true
            video.setAttribute('controls', true)
            // video.controls = true
            peerScreenElement.mainVideo = video

            var tabName = toEmail + ' | Screen'
            var tab = addTab(tabName, 'stream:screen:' + toEmail, video)
            // updateTab(tabName, video)
            switchTab(tab)

            peerScreenElement.mainVideoTab = tab

            video.srcObject = peerScreenElement.srcObject
        })

        var peerEditPreviewElement = document.createElement('div')
        peerEditPreviewElement.classList.add('edit-preview')
        peerElement.appendChild(peerEditPreviewElement)


        var offlineList = document.querySelector('#offline')
        document.querySelector('#right-panel').insertBefore(peerElement, offlineList)

        return peerElement
    }

    function createPeerConnection(toEmail, channel) {
        var peer = team.members[toEmail]

        var peerConnection = new RTCPeerConnection({
            iceServers: [{
                urls: ["stun:stun.prospero.live:5349"],
                // username: 'username',
                // credential: 'oGtata8EdBtFhQUc',
            }]
        })
                
        peerConnection.onicecandidate = function(event) {
            // console.log('about to send iceCandidate', event, toEmail, yourEmail, channel)
            if(event.candidate) {
                webSocket.send(JSON.stringify({
                    type: 'iceCandidate',
                    candidate: event.candidate,
                    to: toEmail,
                    from: yourEmail,
                    channel: reverseChannel(channel),
                }))
            } 
            // else if(!['connected', 'completed'].includes(peerConnection.iceConnectionState)) {
            //     console.log('peerConnection.iceConnectionState', peerConnection.iceConnectionState)
            //     console.log('Restarting Ice')
            //     peerConnection.restartIce()
            // } 
            else {
                // console.log('peerConnection.iceConnectionState', peerConnection.iceConnectionState)
            }
            
        }

        peerConnection.oniceconnectionstatechange = function(event) {
            // console.log('oniceconnectionstatechange', event)
        }

        peerConnection.ontrack = function(event) {
            // console.log('ontrack', toEmail, event.streams)
            // console.log('ontrack channel', channel)

            var videoElement

            if(channel == 'fromVideo') {
                videoElement = team.members[toEmail].peerElement.querySelector('[name="camera"]')
            }
            if(channel == 'fromScreen') {
                videoElement = team.members[toEmail].peerElement.querySelector('[name="screen"]')
            }

            videoElement.srcObject = event.streams[0]
            videoElement.style.display = 'inline'

            if(videoElement.mainVideo) {
                videoElement.mainVideo.srcObject = event.streams[0]
            }
        }

        peerConnection.ondatachannel = function(event) {
            // return
            var dataChannel = event.channel
            team.members[toEmail].dataChannel = dataChannel
            
            dataChannel.onopen = function(event) {
                // console.log('dataChannel opened from', toEmail)

                setInterval(function () {
                    if(dataChannel.readyState == 'open') {
                        dataChannel.send(JSON.stringify({
                            type: 'ping',
                            time: Date.now(),
                        }))
                    }
                }, 5 * 1000)
            }


            dataChannel.onmessage = function(event) {
                handlePeerMessage(JSON.parse(event.data), dataChannel, toEmail)
            }
            
        }

        return peerConnection
    }
    
    function call(toEmail, channel) {
        precall(toEmail, channel)
        return call2(toEmail, channel)
    }

    function precall(toEmail, channel) {
        // console.log('sent precall', toEmail, channel)
        webSocket.send(JSON.stringify({
            type: 'precall',
            to: toEmail,
            from: yourEmail,
            channel: reverseChannel(channel),
        }))
    }

    function call2(toEmail, channel) {
        // console.log('call', toEmail, channel)
        var peerConnection = createPeerConnection(toEmail, channel)

        peerConnection.onnegotiationneeded = function(event) {
            peerConnection.createOffer()
            .then(function(offer) {
                // console.log('offer', toEmail, offer)
                return peerConnection.setLocalDescription(offer)
            })
            .then(function() {
                // console.log('send offer')
                webSocket.send(JSON.stringify({
                    type: 'offer',
                    offer: peerConnection.localDescription,
                    to: toEmail,
                    from: yourEmail,
                    channel: reverseChannel(channel),
                }))
            })
        }

        if(channel == 'toVideo') {
            localVideoStream.getTracks().forEach(function(track) {
                peerConnection.addTrack(track, localVideoStream)
            })
        }

        if(channel == 'toScreen') {
            localScreenStream.getTracks().forEach(function(track) {
                peerConnection.addTrack(track, localScreenStream)
            })
        }

        if(channel == 'data') {
            // return
            var dataChannel = peerConnection.createDataChannel('data')
            team.members[toEmail].dataChannel = dataChannel

            dataChannel.onopen = function(event) {
                // console.log('dataChannel opened to', toEmail)

                setInterval(function () {
                    if(dataChannel.readyState == 'open') {
                        dataChannel.send(JSON.stringify({
                            type: 'ping',
                            time: Date.now(),
                        }))
                    }
                }, 5 * 1000)
            }

            dataChannel.onmessage = function(event) {
                handlePeerMessage(JSON.parse(event.data), dataChannel, toEmail)
            }
            
        }

        return peerConnection
    }

    function getTeam(shortTeamId) {
        var result = null


        user.teams.forEach(function(t) {
            var teamId = t.teamId
            if(teamId.slice(0, 4) == shortTeamId) {
                result = t
            }
        })

        var teamObject = {}
        result.members.forEach(function(email) {
            if(user.email != email) {
                teamObject[email] = {
                    email: email,
                    online: false,
                    peerConnections: {},
                }
            }
        })

        result.members = teamObject

        return result
    }

    function updateOfflineList() {
        var offlineList = document.querySelector('#offline')
        offlineList.innerHTML = '<p name="title" style="font-size: 75%; margin: 1px; text-decoration: underline;">Offline</p>'

        var anyOffline = false
        Object.values(team.members).forEach(function(peer) {
            if(!peer.online) {
                var p = document.createElement('p')
                p.textContent = peer.email
                p.style.margin = '3px'
                p.style.overflow = 'hidden'
                p.style.whiteSpace = 'nowrap'
                offlineList.appendChild(p)
                anyOffline = true
            }
        })

        if(!anyOffline) {
            offlineList.querySelector('[name="title"]').style.display = 'none' 
        }
    }

    function updateInvitedList() {
        var l = document.querySelector('#invited')
        l.innerHTML = '<p name="title" style="font-size: 75%; margin: 1px; text-decoration: underline;">Invited</p>'

        if(team.invited.length > 0) {
            Object.values(team.invited).forEach(function(peer) {
                var p = document.createElement('p')
                p.textContent = peer
                p.style.margin = '3px'
                p.style.overflow = 'hidden'
                p.style.whiteSpace = 'nowrap'
                l.appendChild(p)
                anyInvited = true
            })
        }

        else {
            l.querySelector('[name="title"]').style.display = 'none' 
        }
    }


    // function patchFile(contents, changes) {
    //     changes.forEach(function(change) {
    //         if(change.removed[0].length > 0 || change.removed.length > 0) {
    //             var nDeleted = change.removed.length - 1
    //             change.removed.forEach(function(str) {
    //                 nDeleted += str.length
    //             })
    //             contents = contents.slice(0, change.from.index) + contents.slice(change.from.index + nDeleted)
    //         }
            
    //         if(change.text[0].length > 0 || change.text.length > 0) {
    //             var insertedText = []
    //             change.text.forEach(function(str) {
    //                 insertedText.push(str)
    //             })
    //             insertedText = insertedText.join('\n')
    //             contents = contents.slice(0, change.from.index) + insertedText + contents.slice(change.from.index)
                
    //         }
    //     })

    //     return contents
    // }


    var processedMessages = {}

    var analyser
    var audioBufferLength
    var timeDomainBuffer
    var audioCtx

    function setupAudio(localStream) {
        audioCtx = new AudioContext()
        var source = audioCtx.createMediaStreamSource(localStream)

        analyser = audioCtx.createAnalyser()
        source.connect(analyser)
        audioBufferLength = analyser.fftSize
        timeDomainBuffer = new Uint8Array(audioBufferLength)
    }

    function drawAudioTime() {
        var clipped = false

        if(!analyser) return

        analyser.getByteTimeDomainData(timeDomainBuffer)

        for(var i = 1; i < audioBufferLength; i++) {
            var sample = timeDomainBuffer[i]
            
            if(sample > 256 - 38 || sample < 38) {
                clipped = true
            }
        }

        if(clipped) {
            markTimeline('#ff000004')
        }
    }


    var shortTermMemory = {}
    
    function handlePeerMessage(message, replyChannel, toEmail) {
        if(message.type == 'ping') {
            try {
                replyChannel.send(JSON.stringify({
                    type: 'pong',
                    pingTime: message.time,
                    time: Date.now(),
                }))
            } catch(e) {
                console(e)
            }
        }

        if(message.type == 'pong') {
            var latency = Math.ceil((Date.now() - message.pingTime))
            
            var pElement = team.members[toEmail].peerElement
            if(pElement !== undefined) {
                var l = team.members[toEmail].peerElement.querySelector('.latency')
                l.textContent = latency + 'ms'
            }
        }

        
        if(message.type == 'editor-changes') {
            if(processedMessages[message.id]) {
                return
            }

            else {
                processedMessages[message.id] = true
            }

            var editor  = null
            var tabName = '≡ ' + message.filename + ' in ' + message.filepath
            
            var tabs = document.querySelector('#tabs')
            tabs.querySelectorAll('div').forEach(function(tab) {
                if(tab.key == 'file:' + message.filepath + message.filename && tab.element.querySelector(".CodeMirror"))  {
                    editor = tab.element.querySelector(".CodeMirror").CodeMirror
                }
            })

            var fullPath = message.filepath + message.filename

            if(editor) {
                console.log('\n\n\n----------------------------------\nRECEIVED CHANGE MESSAGE\n')
                console.log('message:', message)


                // Check beforeChecksum and find when it matches
                var otherChanges
            
                var history = editor.history
                console.log('before patch history:', history)
                console.log('before patch checksumTable:', editor.checksumTable)

                var match = editor.checksumTable[message.beforeChecksum]
                
                if(match !== undefined) {
                    otherChanges = history.slice(match.index + 1)
                }

                // console.log('base checksum:', message.beforeChecksum)
                // console.log('base contents:', message.beforeContents)
                // console.log('operations to transform through:', otherChanges)

                // var otherChanges = []
                // var history = editor.history
                // console.log('before patch history:', history)
                // // console.log(history, message.beforeChecksum)
                // history.forEach(function(historyEntry, i) {
                //     if(historyEntry.checksum == message.beforeChecksum) {
                //         otherChanges = history.slice(i + 1)
                //     }
                // })

                // 3 people edited at the same time (or checksums don't match for some other reason)
                // if(otherChanges === undefined) {
                //     send(teamId, 'all', {
                //         type: 'change-confirmation',
                //         success: false,
                //         reason: 'multi-collision',
                //         contents: newContents,
                //         from: email,
                //         path: path,
                //         filename: filename,
                //     })

                //     return
                // }

                if(otherChanges === undefined) {
                    markTimeline('#22f')

                    return
                }

                else if(otherChanges.length > 0) {
                    // add entry to checksum table
                    editor.checksumTable[message.checksum] = {
                        index: match.index,
                        contents: editor.getValue(),
                        historyEntry: editor.history[match.index],
                    }
                }

                var changes = message.changes
                changes.forEach(function(change) {
                    change.madeBy = toEmail
                })

                // Shift message.changes by otherChanges
                // shiftChanges(otherChanges, changes, contents)

                // console.log('before otherChanges:', otherChanges)
                // console.log('before changes:', changes)
                

                console.log('before shift changes:', changes)
                shiftChanges(otherChanges, changes)

                console.log('after shift changes:', changes)
                
                console.log('before patch contents:')
                console.log(editor.getValue())
                console.log('---------------------')
                pprint(editor.getValue())

                // console.log('after otherChanges:', otherChanges)
                // console.log('after changes:', changes)

                // var newContents = patchFile(contents, changes, message.checksum)

                message.changes.forEach(function(change) {
                    var from = editor.posFromIndex(change.from)
                    var to = editor.posFromIndex(change.to)

                    // if(change.origin == '+delete' && (change.removed[0].length > 0 || change.removed.length > 0)) {
                    //     console.log(editor.getValue())
                    //     editor.replaceRange('', change.from, change.to, '+remote')    
                    //     console.log(editor.getValue())
                    // }
                    
                    // if(change.origin == '+input' && (change.text[0].length > 0 || change.text.length > 0)) {
                    //     editor.replaceRange(change.text.join('\n'), change.from, change.to, '+remote')    
                    // }
                    
                    if(change.removed[0].length > 0 || change.removed.length > 1) {
                        // console.log(editor.getValue())
                        editor.replaceRange('', from, to, '+remote')    
                        // console.log(editor.getValue())
                    }
                    
                    if(change.text[0].length > 0 || change.text.length > 1) {
                        // var len = change.text.join('\n')
                        editor.replaceRange(change.text.join('\n'), from, from, '+remote')    
                    }

                    // if((change.removed[0].length > 0 || change.removed.length > 1) && (change.text[0].length > 0 || change.text.length > 1)) {
                    //     console.log('BOTH removed and text', change)
                    // }

                    // console.log(editor.getValue())

                    change.checksum = crc32(editor.getValue().toString('binary'))
                    change.contents = editor.getValue()
                    
                    // console.log('revisionId receive', message.revisionId)
                    // console.log(message.changes)
                })
                

                console.log('after patch contents:')
                console.log(editor.getValue())
                pprint(editor.getValue())

                // if(crc32(editor.getValue()) != message.checksum) {
                //     markTimeline('#f22')
                //     console.log('Checksum mismatch!!!')
                //     console.log(message.changes)
                //     // var cursor = editor.getCursor()
                //     // editor.setValue(message.contents)
                //     // editor.setCursor(cursor)
                // }

                // Add entry to checksum table
                editor.checksumTable[crc32(editor.getValue().toString('binary'))] = {
                    index: editor.history.length,
                    contents: editor.getValue(),
                    historyEntry: changes[0],
                }

                editor.history = editor.history.concat(changes)
                console.log('after patch history:', editor.history)
                console.log('after patch checksumTable:', editor.checksumTable)

                editor.beforeChecksum = crc32(editor.getValue().toString('binary'))
                editor.beforeContents = editor.getValue()

                // if(shortTermMemory[fullPath].length > 50) {
                //     shortTermMemory[fullPath] = shortTermMemory[fullPath].slice(shortTermMemory[fullPath].length - 50)
                // }
            }
        }


        if(message.type == 'cursor-position') {
            // console.log('cursor-position', message)
            var editor  = null
            var tabName = '≡ ' + message.filename + ' in ' + message.filepath
            
            var tabs = document.querySelector('#tabs')
            tabs.querySelectorAll('div').forEach(function(tab) {
                if(tab.key == 'file:' + message.filepath + message.filename && tab.element.querySelector(".CodeMirror")) {
                    editor = tab.element.querySelector(".CodeMirror").CodeMirror
                }
            })

            var peerEditPreview = team.members[toEmail].peerElement.querySelector('.edit-preview')
            peerEditPreview.innerHTML = '<pre style="margin: 0; font-family: Cousine, monospace;">' + sanitizeHTML(message.nearby) + '</pre>'

            // peerEditPreview.addEventListener('click', function() {
            //     var fileView = createFileView(message.filename, message.filepath)
            //     var icon = getIconFromFilename(message.filename)
            //     var tab = addTab(icon + ' ' + message.filename, 'file:' + message.filepath + message.filename, fileView)

            //     switchTab(tab)
            // })

            if(editor && team.members[toEmail]) {
                var cursorPos = {
                    line: message.line,
                    ch: message.ch,
                }
                var cursorCoords = editor.cursorCoords(cursorPos);


                if(team.members[toEmail].cursor) {
                    team.members[toEmail].cursor.clear()
                }

                var cursorElement = document.createElement('span');
                cursorElement.style.borderLeftStyle = 'solid';
                cursorElement.style.borderLeftWidth = '2px';
                // cursorElement.style.borderLeftColor = '#ff0000';
                cursorElement.style.borderLeftColor = team.members[toEmail].peerElement.color;
                // cursorElement.style.height = (cursorCoords.bottom - cursorCoords.top) + 'px'
                // cursorElement.style.height = '16px'
                cursorElement.style.padding = 0;
                cursorElement.style.marginLeft = '-2px';
                // cursorElement.style.marginTop = '-3px';
                // cursorElement.style.display = 'inline-block';
                // cursorElement.style.zIndex = 0;

                var otherCursor = editor.setBookmark(cursorPos, {
                    widget: cursorElement,
                })

                if(team.members[toEmail].cursorInterval) {
                    clearInterval(team.members[toEmail].cursorInterval)
                }

                team.members[toEmail].cursorPos = cursorPos
                team.members[toEmail].cursorState = true
                team.members[toEmail].cursorInterval = setInterval(function() {
                    if(team.members[toEmail] && team.members[toEmail].peerElement) {
                        if(team.members[toEmail].cursorState) {
                            // cursorElement.style.borderLeftColor = '#ffcccc'
                            cursorElement.style.borderLeftColor = '#ffffff80'
                            team.members[toEmail].cursorState = false
                        } else {
                            // cursorElement.style.borderLeftColor = '#ff0000'
                            cursorElement.style.borderLeftColor = team.members[toEmail].peerElement.color
                            team.members[toEmail].cursorState = true
                        }
                    }
                }, 530)
                team.members[toEmail].cursor = otherCursor
            }
        }
    }

    var timeline = {}
    function markTimeline(color) {
        timeline[Date.now()] = color
    }


    function startTimeline() {
        var canvas = document.querySelector('#timeline canvas')
        canvas.setAttribute('height', canvas.clientHeight)
        canvas.setAttribute('width', canvas.clientWidth)

        requestAnimationFrame(drawTimeline)    
    }
    
    var renderTimestamp = 0
    var smoothFps = 0

    function drawTimeline(timestamp) {
        var fps = 1000 / (timestamp - renderTimestamp)
        renderTimestamp = timestamp
        
        var delta = fps - smoothFps
        smoothFps = smoothFps + 0.01 * delta

        document.querySelector('#fps').textContent = Math.round(smoothFps) + ' fps'

        var speed = 4
        var ctx = document.querySelector('#timeline canvas').getContext('2d')
        
        // ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
        
        ctx.fillStyle = '#fff2'
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height)

        t = 0
        var x
        while(true) {
            x = getX(t)
            
            if(t % 1000 == 0) {
                drawVerticalLine(x, '#ccc', 1)
            }
            
            else if(t % 200 == 0) {
                drawVerticalLine(x, '#eee')
            }

            else if(t % 100 == 0) {
                drawVerticalLine(x, '#eee', 1, 5)
            }
            
            else {
                drawVerticalLine(x, '#eee', 1, 3)
            }
            
            t += 50

            if(getX(t) > x) {
                break
            }
        }
        
        cleanTimeline()
        
        drawAudioTime()
        
        Object.keys(timeline).forEach(function(t) {
            var color = timeline[t]
            drawVerticalLine(getX(t), color, 4)
        })

        drawVerticalLine(getX(Date.now()), '#ccc')

        function getX(t) {
            return ctx.canvas.width - t / speed % ctx.canvas.width
        }

        function cleanTimeline() {
            Object.keys(timeline).forEach(function(t) {
                if(Date.now() - parseInt(t) > getCycleTime()) {
                    delete timeline[t]
                }
            })
        }

        function getCycleTime() {
            return ctx.canvas.width * speed
        }

        function drawVerticalLine(x, color, width, height) {
            if(width === undefined) {
                width = 1
            }
            
            if(height === undefined) {
                height = ctx.canvas.height
            }

            ctx.strokeStyle = color
            ctx.lineWidth = width

            ctx.beginPath()
            ctx.moveTo(Math.round(x), 0)
            ctx.lineTo(Math.round(x), height)
            ctx.closePath()
            ctx.stroke()
        }

        requestAnimationFrame(drawTimeline)
    }

    function toast(message, timeout, priority) {
        if(!timeout) {
            timeout = 15
        }

        if(!priority) {
            priority = 0
        }

        var toast = document.createElement('div')
        toast.innerHTML = message

        toast.style.fontFamily = 'Inconsolata'

        toast.style.zIndex = priority + 2000
        toast.style.position = 'fixed'
        // toast.style.left = '300px'
        toast.style.height = '52px'
        toast.style.width = '80%'
        toast.style.fontSize = '150%'
        toast.style.background = '#ff0e'
        toast.style.border = '1px solid #555'
        toast.style.borderRight = '2px solid #555'
        toast.style.borderRadius = '10px 10px 0px 0px'
        toast.style.padding = '15px 40px'
        toast.style.left = '50%'
        toast.style.transform = 'translate(-50%, 0%)'
        
        toast.style.transition = 'bottom 0.3s'
        toast.style.bottom = '-100px'
        

        toast.classList.add('toast')

        document.body.appendChild(toast)

        setTimeout(function() {
            toast.style.bottom = '0px'
            
            setTimeout(function() {
                toast.style.bottom = '-100px'
                
                setTimeout(function() {
                    document.body.removeChild(toast)
                }, 500)
            }, timeout * 1000)
        }, 100)
    }

    // function dm(to, message, link) {
    //     webSocket.send(JSON.stringify({
    //         type: 'dm',
    //         to: to,
    //         message: message || '',
    //         link: link || '',
    //         time: Date.now(),
    //     }))
    // }

    var sanitizeHTML = function(str) {
        var elm = document.createElement('div')
        elm.textContent = str
        return elm.innerHTML
    }

    var editorKeymap = localStorage.editorKeymap || 'sublime'

    function setKeymap(keymap) {
        editorKeymap = keymap
        localStorage.editorKeymap = keymap
    }

    // change {
    //     to, from, text, removed, checksum (coordinate system)
    // }

    // function merge(proposedChange, yourPreviousChanges, partnerPreviousChanges) {
    //     // proposedChange -> client coords
    //     // yourPreviousChanges[0] -> common base coords
    //     // yourPreviousChanges[n] -> yourPreviousChanges[n-1]
    //     // partnerPreviousChanges[0] -> common base coords
    //     // partnerPreviousChanges[n] -> partnerPreviousChanges[n-1]
        

    //     // transformedPropsedChange -> yourPreviousChanges[-1] (merge) partnerPreviousChanges[-1] 
    //     return transformedProposedChange
    // }

    function shiftChanges(missedChanges, proposedChanges) {
        var extraPatches = []
        proposedChanges.forEach(function(proposedChange) {
            missedChanges.forEach(function(missedChange, i) {
                if(missedChange.madeBy != proposedChange.madeBy) {
                    var extraPatch = transformChange(missedChange, proposedChange)
                    
                    if(extraPatch) {
                        extraPatch.i = i
                        extraPatches.push(extraPatch)        
                    }
                }
            })
        })

        extraPatches.forEach(function(extraPatch, i) {
            proposedChanges = proposedChanges.slice(0, extraPatch.i + i).concat([extraPatch, proposedChanges.slice(extraPatch.i + i)])
        })
    }


function transformChange(committedChange, patch) {
    var extraPatch = {}
    
    // 1) Shift delete patch by delete committedChange
    // var deleteAmount = 0
    // if(isBefore(committedChange.from, patch.to) && isAfter(committedChange.to, patch.from)) {
    //     deleteAmount = getDistance(committedChange.to, committedChange.from)
    // }
    
    // else if(isBefore(committedChange.from, patch.to)) {
    //     deleteAmount = getDistance(patch.to, committedChange.from)
    // }
    
    // else if(isAfter(committedChange.to, patch.from)) {
    //     deleteAmount = getDistance(committedChange.to, patch.from)
    // }
    
    // shiftBy(patch, 'to', -deleteAmount)
    
    // // 2) Shift delete patch by insert committedChange
    // var shiftAmount = 0
    // if(isAfter(patch.from, committedChange.from)) {
    //     // MAYBE - shiftAmount = committedChange.removed.length
    //     shiftAmount = committedChange.text.length
    //     shiftBy(patch, 'from', shiftAmount)
    //     shiftBy(patch, 'to', shiftAmount)
    // }

    // else if(isAfter(patch.to, committedChange.from)) {
    //     patch.to = committedChange.from
    //     extraPatch.from = committedChange.from + committedChange.text.length
    //     extraPatch.to = patch.to + committedChange.text.length
    // }

    // // 3) Shift insert patch by delete committedChange
    // var insertShift = 0
    // if(isAfter(patch.from, committedChange.from)) {
    //     if(isAfter(patch.from, committedChange.to)) {
    //         insertShift = getDistance(committedChange.to, committedChange.from)
    //     }
        
    //     else {
    //         insertShift = getDistance(patch.to, committedChange.from)
    //     }
    // }

    // shiftBy(patch, 'from', -insertShift)

    // 4) Shift insert patch by insert committedChange
    if(isAfter(patch.from, committedChange.from)) {
        shiftBy(patch, 'from', committedChange.text.length)
    }

    if(isSamePosition(patch.from, committedChange.from)) {
        if(patch.madeBy > committedChange.madeBy) {
            shiftBy(patch, 'from', committedChange.text.length)
        }
    }

    return extraPatch
}


    // function transformChange(committedChange, patch) {
    //     var extraPatch = {}
        
    //     // 1) Shift delete patch by delete committedChange
    //     var deleteAmount = 0
    //     if(isBefore(committedChange.from, patch.to) && isAfter(committedChange.to, patch.from)) {
    //         deleteAmount = getDistance(committedChange.to, committedChange.from)
    //     }
        
    //     else if(isBefore(committedChange.from, patch.to)) {
    //         deleteAmount = getDistance(patch.to, committedChange.from)
    //     }
        
    //     else if(isAfter(committedChange.to, patch.from)) {
    //         deleteAmount = getDistance(committedChange.to, patch.from)
    //     }
        
    //     shiftBy(patch, 'to', -deleteAmount)
        
    //     // 2) Shift delete patch by insert committedChange
    //     var shiftAmount = 0
    //     if(isAfter(patch.from, committedChange.from)) {
    //         shiftAmount = committedChange.text.length
    //         shiftBy(patch, 'from', shiftAmount)
    //         shiftBy(patch, 'to', shiftAmount)
    //     }

    //     else if(isAfter(patch.to, committedChange.from)) {
    //         patch.to = committedChange.from
    //         extraPatch.from = committedChange.from + committedChange.text.length
    //         extraPatch.to = patch.to + committedChange.text.length
    //     }

    //     // 3) Shift insert patch by delete committedChange
    //     var insertShift = 0
    //     if(isAfter(patch.from, committedChange.from)) {
    //         if(isAfter(patch.from, committedChange.to)) {
    //             insertShift = getDistance(committedChange.to, committedChange.from)
    //         }
            
    //         else {
    //             insertShift = getDistance(patch.to, committedChange.from)
    //         }
    //     }

    //     shiftBy(patch, 'from', -insertShift)

    //     // 4) Shift insert patch by insert committedChange
    //     if(isAfter(patch.from, committedChange.from)) {
    //         shiftBy(patch, 'from', committedChange.text.length)
    //     }

    //     if(isSamePosition(patch.from, committedChange.from)) {
    //         if(patch.madeBy > committedChange.madeBy) {
    //             shiftBy(patch, 'from', committedChange.text.length)
    //         }
    //     }

    //     return extraPatch
    // }

    function getDistance(a, b) {
        return b - a
    }

    function isBefore(a, b) {
        return a < b
    }

    function isAfter(a, b) {
        return a > b
    }

    function isSamePosition(a, b) {
        return a == b
    }

    function shiftBy(obj, attr, amount) {
        obj[attr] += amount
    }


    function pprint(str) {
        str.split('').forEach(function(ch, i) {
            // console.log(i, )
            if(ch == '	') {
                console.log(i, 'TAB', ch.charCodeAt(0), )
            } else if(ch == '\n') {
                console.log(i, 'NEWLINE', ch.charCodeAt(0))
            } else {
                console.log(i, ch, ch.charCodeAt(0))
            }
        })
    }

    function promptForPayment() {
        var f = document.createElement('form')
        
        var h2 = document.createElement('h2')
        h2.textContent = 'Upgrade to a paid account to upload a file larger than 100KB.'
        h2.style.marginBottom = '20px'
        
        var p = document.createElement('p')
        p.textContent = 'Paid users get 100MB cloud storage. $9 / month. Billed monthly.'
        // p.style.margin = '50px'
        
        var button = document.createElement('button')
        button.textContent = 'Upgrade to paid account'

        var message = document.createElement('p')
        message.textContent = ''

        f.appendChild(h2)
        f.appendChild(p)
        // f.appendChild(input)
        f.appendChild(button)
        f.appendChild(message)
        
        f.addEventListener('submit', function(event) {
            event.preventDefault()

            fetch('/api/payment', {
                method: 'POST',
                headers: {
                    Authorization: 'Bearer ' + localStorage.sessionId,
                },
            }).then(function (response) {
                if (response.ok) {
                    return response.text()
                }
            }).then(function(sessionId) {
                stripe.redirectToCheckout({
                    sessionId: sessionId,
                }).then(function (result) {
                    console.log(result.error.message)
                    // If `redirectToCheckout` fails due to a browser or network
                    // error, display the localized error message to your customer
                    // using `result.error.message`.
                });
            })

            return false
        })
        
        openModal(f)
    }

    var stripe = Stripe('pk_test_IDMiC3EaKk17E7Ymp9pkdlaC');

    // function getDistance(a, b) {
    //     var numNewLines = a.line - b.line - 1
    // }

    // function isBefore(a, b) {
    //     if(a.line < b.line || (a.line == b.line && a.ch < b.ch)) {
    //         return true
    //     }

    //     return false
    // }

    // function isAfter(a, b) {
    //     if(a.line > b.line || (a.line == b.line && a.ch > b.ch)) {
    //         return true
    //     }

    //     return false
    // }

    // function isSamePosition(a, b) {
    //     if(a.line == b.line && a.ch == b.ch) {
    //         return true
    //     }

    //     return false
    // }

    // function shiftBy(obj, attr, amount, editor) {
    //     // obj[attr] += amount

    //     var pos = obj[attr]
    //     var line

    //     while(amount > 0) {
    //         line = editor.getLine(pos.line)
            
    //         if(line.length < -amount) {
    //             pos.line -= 1
    //             amount -= line.length
    //         }
            
    //         else {
    //             pos.ch = line.length - amount
    //             amount = 0
    //         }
    //     }

    //     while(amount < 0) {
    //         line = editor.getLine(pos.line)
            
    //         if(line.length < -amount) {
    //             pos.line -= 1
    //             amount -= (-line.length)
    //         }
            
    //         else {
    //             pos.ch = line.length - (-amount)
    //             amount = 0
    //         }
    //     }
    // }
</script>

</body>


</html>