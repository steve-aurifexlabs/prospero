<!doctype html>
<html lang="en">
<head>
    <meta charset="utf8">
    <link rel="shortcut icon" type="image/png" href="data:image/png;base64,">
    <title>MIDI Synth | Aurifex Labs</title>
</head>
<body>
    
<style>
body { font-family: sans-serif; }
body > * { background-color: #efe; }
body > * { outline: 1px dotted #444; }
body > * { padding: 0.5em; }
body > * { margin: 10px; }
nav, footer { font-size: 75%; }
nav a, footer a { padding: 0.25em; }
h2 { text-decoration-line: underline; }
header [name="email"] { float: right; }
</style>

<header>
    <span name="email">Loading...</span>
    <nav>
        <a href="/">Home</a>
        <a href="/account">Account</a>
        <a href="/storage/">Storage</a>
        <a href="/teams">Teams</a>
    </nav>
    <h1>MIDI Synth</h1>
</header>

<div>
    <h2>Synth</h2>
    <button type="button">Play song</button>
    <p>Notes: <span name="notes-played"></span></p>
    <p>Notes 2:</p>
    <p class="notes2"><span name="notes-played2"></span></p>
    <p>Notes 3:</p>
    <div>
        <div name="notes3-names">
            <p class="high">D6</p>
            <p class="high">C6</p>
            <p class="high">Bb5</p>
            <p class="high">A5</p>
            <p class="high">G5</p>
            <p class="high">F5</p>
            <p class="mid">E5</p>
            <p class="mid">Eb5</p>
            <p class="mid">D5</p>
            <p class="mid">C5</p>
            <p class="mid">Bb4</p>
            <p class="mid">A4</p>
            <p class="mid">G4</p>
            <p class="mid">F4</p>
            <p class="mid">E4</p>
            <p class="mid">Eb4</p>
            <p class="mid">D4</p>
            <p class="low">C4</p>
            <p class="low">Bb3</p>
            <p class="low">F3</p>
            <!-- <p>Horse</p> -->
            <!-- <p>Clap</p> -->
        </div>
        <div style="position: relative; top: -380px; left: 100px;" name="notes3-main"></div>
    </div>
    <p></p>
    <p><span name="notes-played3"></span></p>

    <p><span class="low">Bass</span> | Sine wave -> Distortion 0 -> Biquad highshelf 1500hz +6db</p>
    <p><span class="mid">Accompaniment</span> | Sine wave -> Distortion 20 -> Biquad highshelf 1000hz -3db</p>
    <p><span class="high">Melody</span> | Sine wave -> Distortion 400 -> Biquad highshelf 1500hz -6db</p>
    <p>-> Compressor | Threshold -60db | Knee +40db | Ratio +20db in -> +1db out | Attack none | Release -10db@250ms</p>
    <p>-> Gain | 0.2</p>
</div>

<audio name="horse" src="/content/audio/horse.wav"></audio>
<audio name="clap" src="/content/audio/clap.wav"></audio>

<div>
    <h2>MIDI</h2>
    <p>Tempo: 250000 us/beat = 4 beats per second = 240 bpm</p>
    <p>Ticks per beat: 120</p>
    <p>Key signature: C major</p>
    <p>Time signature: 4/4</p>
    <p>Notes: 1 beat per 1/8 note -> 120 ticks per 1/8 note, 240 ticks per 1/4 note</p>
    <p>Notes used: <span name="notes-used"></span></p>
    <pre name="music-notation"></pre>
</div>

<footer>
    <p>
        <a href="/terms-of-service">Terms of Service</a>
        <a href="/privacy-policy">Privacy Policy</a>
        <a href="mailto:contact@aurifexlabs.com">Contact</a>
        <span>Copyright 2019 Aurifex Labs LLC</span>
    </p>
</footer>

<style>
pre {
    font-size: 100%;
}

.notes2 {
    font-size: 1.4vw;
}

.note {
    color: #eee;
}
.twenty-note-scale {
    color: #aaa;
}
.playing {
    color: black;
}

.flat {
    position: relative;
    top: -5px;
}

.low {
    color: #00f;
}

.mid {
    color: #0f0;
}

.high {
    color: #f00
}

[name="notes3-names"] p {
    margin: 0;
} 
</style>

<script>
    window.addEventListener('DOMContentLoaded', function (event) {
        document.querySelector('header [name="email"]').textContent = ''
        var song = preprocessMIDI()

        var button = document.querySelector('button')
        button.addEventListener('click', function() {
            console.log('play note')
            playSong(song)
        })
    })

    var playTimer = 0

    function playSong(song) {
        // var usPerBeat = 250000
        var usPerBeat = 260000
        var beatsPerSecond = 1e6 / usPerBeat
        var ticksPerBeat = 120
        var ticksPerSecond = ticksPerBeat * beatsPerSecond
        
        var tickLength = 1000 / ticksPerSecond
        var cursor = 0
        
        var event = song[cursor]
        setTimeout(processEvent, event.deltaTime * tickLength)

        function processEvent() {   
            var event = song[cursor]
            playTimer = event.time

            if(event.on) {
                playNote(event.noteNumber)
            } else {
                stopNote(event.noteNumber)
            }

            cursor += 1

            while(true) {
                var event = song[cursor]

                if(event.deltaTime) {
                    setTimeout(processEvent, event.deltaTime * tickLength)
                    displayPlayedNotes()
                    displayPlayedNotes2()
                    displayPlayedNotes3()
                    break
                } else {
                    if(event.on) {
                        playNote(event.noteNumber)
                    } else {
                        stopNote(event.noteNumber)
                    }

                    cursor += 1
                }
            }
        }
    }

    function displayPlayedNotes() {
        var notesElement = document.querySelector('[name="notes-played"]')
        // notesElement.textContent = Object.keys(noteOscillators)
        notesElement.textContent = ''
        
        var output = ''
        Object.keys(noteOscillators).forEach(function(noteNumber) {
            var noteName = getNoteName(noteNumber)
            output += noteName + ' '
        })
        notesElement.textContent += output    
    }

    function displayPlayedNotes2() {
        var notesElement = document.querySelector('[name="notes-played2"]')
        notesElement.textContent = ''
        
        var lower = 53
        var upper = 86

        var output = ''
        for(var n = lower; n <= upper; n++) {
            var c = 'note'
            var noteName = getNoteName(n)
            if(notesUsed.includes(noteName)) {
                c = 'twenty-note-scale'
            }
            if(noteOscillators[n]) {
                c = 'playing'
                if(n <= 60) {
                    c += ' low'
                }
                else if(n <= 76) {
                    c += ' mid'
                }
                else {
                    c += ' high'
                }
            }
            if(noteName.includes('b')) {
                c += ' flat'
            }
            
            
            output += '<span class="' + c + '">' + noteName + '</span> '
        }

        notesElement.innerHTML = output
    }

    function displayPlayedNotes3() {
        var notesElement = document.querySelector('[name="notes3-main"]')
        
        var offsets = [
            'D6', 'C6', 'Bb5', 'A5', 'G5', 'F5',
            'E5', 'Eb5', 'D5', 'C5', 'Bb4', 'A4', 'G4', 'F4', 'E4', 'Eb4', 'D4',
            'C4', 'Bb3', 'F3',
        ]

        Object.keys(noteOscillators).forEach(function(noteNumber) {
            var noteName = getNoteName(noteNumber)
            var height = 19
            var offset = offsets.indexOf(noteName) * height
            
            var elm = document.createElement('span')
            elm.textContent = noteName
            elm.style.position = 'absolute'
            elm.style.top = offset + 'px'
            elm.style.left = playTimer + 'px'
            
            notesElement.appendChild(elm)
        })
    }

    var forceRight = false

    setInterval(function() {
        if(forceRight) {
            scrollTo({ left: 10000000 })
        }
    }, 30)

    var noteOscillators = {}

    function makeDistortionCurve(amount) {
        var k = typeof amount === 'number' ? amount : 50,
            n_samples = 44100,
            curve = new Float32Array(n_samples),
            deg = Math.PI / 180,
            i = 0,
            x;
        for ( ; i < n_samples; ++i ) {
            x = i * 2 / n_samples - 1;
            curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
        }
        return curve;
    }

    function playNote(noteNumber) {
        // noteNumber -= 12
        if(noteOscillators[noteNumber]) return

        var audioContext = new AudioContext()

        if(noteNumber == 127) {
            console.log('horse')
            var horse = document.querySelector('audio[name="horse"]')
            var source = audioContext.createMediaElementSource(horse)
            source.connect(audioContext.destination)
            horse.play()
            // noteOscillators[noteNumber] = oscillator
            return
        }

        if(noteNumber == 126) {
            console.log('clap')
            var clap = document.querySelector('audio[name="clap"]')
            var source = audioContext.createMediaElementSource(clap)
            source.connect(audioContext.destination)
            clap.play()
            // noteOscillators[noteNumber] = oscillator
            return
        }

        var frequency = 440 * Math.pow(2, ((noteNumber - 69) / 12)) 

        var oscillator = audioContext.createOscillator()
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime)
        
        var biquadFilter = audioContext.createBiquadFilter()
        // biquadFilter.type = 'highshelf'
        // biquadFilter.frequency.setValueAtTime(1000, audioContext.currentTime)
        // biquadFilter.gain.setValueAtTime(3, audioContext.currentTime)
        
        var distortion = audioContext.createWaveShaper()
        // distortion.curve = makeDistortionCurve(2000)
        distortion.oversample = '4x'
        
        if(noteNumber <= 60) {
            oscillator.type = 'sine'
            biquadFilter.type = 'highshelf'
            biquadFilter.frequency.setValueAtTime(1500, audioContext.currentTime)
            biquadFilter.gain.setValueAtTime(6, audioContext.currentTime)
            distortion.curve = makeDistortionCurve(0)
        } else if(noteNumber <= 76) {
            oscillator.type = 'sine'
            biquadFilter.type = 'highshelf'
            biquadFilter.frequency.setValueAtTime(1000, audioContext.currentTime)
            biquadFilter.gain.setValueAtTime(-3, audioContext.currentTime)
            distortion.curve = makeDistortionCurve(20)
        } else {
            oscillator.type = 'sine'
            biquadFilter.type = 'highshelf'
            biquadFilter.frequency.setValueAtTime(1500, audioContext.currentTime)
            biquadFilter.gain.setValueAtTime(-6, audioContext.currentTime)
            distortion.curve = makeDistortionCurve(400)
        
        }
        
        var compressor = audioContext.createDynamicsCompressor()
        compressor.threshold.setValueAtTime(-60, audioContext.currentTime)
        compressor.knee.setValueAtTime(40, audioContext.currentTime)
        compressor.ratio.setValueAtTime(20, audioContext.currentTime)
        compressor.attack.setValueAtTime(0, audioContext.currentTime)
        compressor.release.setValueAtTime(0.25, audioContext.currentTime)
        
        var gainNode = audioContext.createGain()
        gainNode.gain.value = 0.5
        
        oscillator.connect(distortion)
        distortion.connect(biquadFilter)
        biquadFilter.connect(compressor)
        compressor.connect(gainNode)
        gainNode.connect(audioContext.destination)
        
        oscillator.start()
        noteOscillators[noteNumber] = oscillator
    }

    function stopNote(noteNumber) {
        // noteNumber -= 12
        if(!noteOscillators[noteNumber]) return
        noteOscillators[noteNumber].stop()
        delete noteOscillators[noteNumber]
    }

    function readMusic() {
        return '003c645051641452640a51000a3c000046640043640041640054640a52003241000046000043000054003c4f64003c643c4f00004d643c4d00003c000046640043640041640048643c48000046000043000041003c4d64003c643c4d003c3c00004664004364004164004864004f643c48000041000046000043003c4364003c643c43000041643c4100003c000046640043640048643c48000043000046003c3c64004164284f001441001451641452640a51000a3c000046640041640054640043640a52003254000046000041003c3c64004f643c4f00004d643c4d00003c000046640041640048643c48000043000046000041003c3c64004d643c4d003c3c00004664004364004164004864004f643c48000041000046000043003c3c640043643c43000041643c4100003c000046640043640048643c48000043000046003c4164003c64284f001441001451641452640a51000a3c000046640041640054640043640a52003254000046000041003c4f64003c643c4f00004d643c4d00003c000046640041640048643c48000043000046000041003c4164004d64003c643c4d000041003c3c00004664004164004364004f643c4f000046000041000043000048640054643c5400004800004664003c64004364004f643c4f000043000046003c3c00004664004164004d643c4d000041000046000048643c4800003c64004164004d643c4d00004100004364004f643c4f00004300003c00004d640041640048640054640046643c4600004800005400004d003c4864003c64004f643c4f000048003c3c00004864004664004d643c4d000046000048003c4100003c640046640040640048643c4800003c000046000040003c4864004c640051640054643c5400004800004c000051003c4c640051640054640048643c4800004c000051000054003c4864003c64004c640051640054643c5400004c00004800003c00005100285664144164003564004c640051640054640a5600325100004c000041000054003c3500004064004564004864004c64004f643c4f00004800004000004500004c003c4064004564004c64004864004f643c4f00004c000040000045000048003c3c64004564004c64004f640048643c4800004c00003c00004500004f00285164144164003564004564004c64004864004f640a5100324800004c00004500004100004f003c3500004564004164003e640048643c4800004500004100003e003c4164003e640048640045643c4500004100003e000048003c3c64003e640041640045640048643c4800004100003c00003e00004500284a64143564004564004164003e640048640a4a00324500004100003e000048003c3500004064004564004864004c64004f643c4f00004800004000004500004c003c4064004c64004864004564004f643c4f00004800004000004c000045003c4064003c64004864004c64004564004f643c4f00003c00004800004000004500004c00285164143e64003564004c64004864004564004f640a5100324500003500004c00003e00004f000048003c54643c54003c54643c54003c54643c54002856641435640054640040640a56003254003c35000045640041640056643c56000041000045003c4000003c64005464003e643c54000051643c5100003c00004564004164004d643c4d000041000045003c3e00003c64004f640041643c4f003c3c000046640051640043643c43000051000046003c4100003c64004f640040643c4f00004d643c4d00003c00004364004664004a643c4a000040000043000046003c35640048640040647835000041640045643c45000041003c4000003c64003e64783c000045640041643c41000045003c3e00004164003c643c48003c3c00004364004664004a643c4a00004600004300004c643c4c00004100003c64004d640040643c4d00004f643c4f00003c000046640043640051643c51000040000046000043000052643c52000035640054640040643c54003c35000041640045640056643c56000045000041003c4000003c64005464003e643c54000051643c5100003c00004164004f640045643c4500004f00004100004d643c4d00003e00003c64004f640041643c4f003c3c00004364004664004f643c4f000046000043000051643c5100004100003c64004f640040643c4f00004d643c4d00003c00004664004364004a643c4a000043000046003c4000003564004d640041645041002835000045640041640048643c48000041000045003c3c64004a64784a00003c000045640041640048643c48000041000045003c4b64003f643c4d003c3f00004b00004f640043640048640054643c5400004f000043000048003c4064005464004c643c54003c4c00004000004f640046640043640048640054643c5400004300004f000046000048003c45640035640054640040643c54000045003c35000046640041640056643c56000041000046003c4000004564003c64005464003e643c54000045000048640051643c5100004800003c00004564004164004d643c4d000041000045003c3e00004664003c64004f640041643c4f000046003c3c00004d640046640051640043643c4300004600005100004d003c4100004c64003c64004f640040641e4c001e4f00004a64004d641e4a001e4d00003c00004364004664004a643c4a000040000043000046003c35640048640040643c4c643c4c00003500004d640041640045643c4500004d00004100004f643c4f00004000005164003c64003e643c5100004c643c4c00003c00004d640045640041643c4100004d000045000051643c5100003e00005464004164003c643c54000048003c3c00004364004664004a643c4a00004600004300004c643c4c00004100003c64004d640040643c4d00004f643c4f00003c000046640043640051643c51000040000046000043000052643c52000045640035640054640040643c54000045003c35000041640046640056643c56000046000041003c4000004564003c64005464003e643c54000045000051643c5100003c00004864004164004f640045643c4500004100004f00004800004d643c4d00003e00004664003c64004f640041643c4f000046003c3c00004364004664004f643c4f000046000043000048640051643c5100004800004100004664003c64004f640040643c4f00004600004d643c4d00003c00004664004364004a641e46001e4a00004300004864144a640a48000a4c640a4a000a4000003564004d640041640a4c003245641441000046640a45000a48640a46000a3500005264004a640041640a48003241003c4a00005200003c640051640048643c48000051003c3c000045640041641e45001e41000045641446640a45000a48640a46000a3564005264004a640a4800324d003c5200003500004a000045640041640051640048643c48000045000041000051003c41640045640035640051640048643c48000035000041000045000051003c4a643c4a00004b643c4b00004864003c640052643c52003c3c00004800004364003f64004a643c4a00003f00004300004b641446641445640a46000a4b00004364003c640052640a45003252003c3c00004664003f64004a643c4a00004300004600003f00004164004b643c4b00004100003f64003c640052643c52003c3c000043640046640054643c5400003f00004300004600143f641440640a3f000a41640051640035640a40006e3500004564003f643c3f000045003c4100003e64003a643c51003c3a000041640046640052643c52000046000041003c35640051643c5100004d64143e00284d00003500004664004164003e64004a641e3e000a3f64144600004a000041000a3f000a40641e40000a4164003a64004f64783a00003e640046643c4600003e00144100283a64004164644100143a000046640043640040643c4300004f000046003c4000003c64003f64783c000043640048640051643c51000048000043003c3c64004f643c4f00004b643c4b00003c000043640048643c4800004300003f00004b643c4b00003c64003f64004f643c4f003c3c000048640043640052643c52000043000048003c3f000035640041640051643c51000052643c5200003500003f640045640048640054643c5400004500004800003f003c4100003a64004d643c3e64143f640a3e000a3f00004064143a00003e640041640045640048640a4000323e00144500284100004800003e64004364004664784600004300003e000035643c3500003e64143f640a3e000a40640a3f000a4164004564004864003a640a4000464500284800004100003a00003e640043640046643c4600004300003e003c3e64004364004664003a643c4600004300004d00003e003c3a00004164003e640045643c4500003e000041000046643c4600004a64003e64003a64004d641e4d000a4f64144a000a4f000a4d641e4d000a3a000041640045643c45000041000046643c4600004a64003a64004d641e4d000a4f64144a000a4f000a3e00004d641e4d000a3a00004164003e640045643c4500003e000041000046643c4600004a64003e64003a64004d643c4d00004a003c3a00004664004164004f643c4f00004100004600283e00144064003c64004c64644000143c000040640043640048643c48000043000040000046643c4600004c00004564003564783500004864004164004d643c4d000041000048003c3c64004c643c4c000045000048643c4800003c000041640045643c45000041003c4a640035640041641e41000a43641e43000a45641e45000a3500004d64004164004664144a000a46000a4864144100004d000a48000a4a641e4a000a4b64003c641e4b000a4c641e4c000a4d641e4d000a3c00004864004564004164004f641e4f000a51641448000041000045000a51000a52641e52000a4064004664004864004c64005464003c643c3c00004600004800004000005400004c003c48640054643c54000048003c4364004f643c4f00004300004164004d643c4d00004100003c640048643c4800003c003c4164004d643c4d000041003c4364004f643c4f000043000048640054643c5400004800004364004f643c4f000043003c4164004d643c4d00004100003c640048643c4800003c00004164004d643c4d00004100004364004f643c4f000043000048640054643c54000048003c4364004f643c4f000043003c4164004d643c4d000041003c3c640040640046640048643c4800003c000040000046003c54643c54003c54643c54003c54643c54002856641435640054640040640a56003254003c35000045640041640056643c56000041000045003c4000003c64005464003e643c54000051643c5100003c00004564004164004d643c4d000041000045003c3e00003c64004f640041643c4f003c3c000046640051640043643c43000051000046003c4100003c64004f640040643c4f00004d643c4d00003c00004364004664004a643c4a000040000043000046003c35640048640040647835000041640045643c45000041003c4000003c64003e64783c000045640041643c41000045003c3e00004164003c643c48003c3c00004364004664004a643c4a00004600004300004c643c4c00004100003c64004d640040643c4d00004f643c4f00003c000046640043640051643c51000040000046000043000052643c52000035640054640040643c54003c35000041640045640056643c56000045000041003c4000003c64005464003e643c54000051643c5100003c00004164004f640045643c4500004f00004100004d643c4d00003e00003c64004f640041643c4f003c3c00004364004664004f643c4f000046000043000051643c5100004100003c64004f640040643c4f00004d643c4d00003c00004664004364004a643c4a000043000046003c4000003564004d640041645041002835000045640041640048643c48000041000045003c3c64004a64784a00003c000045640041640048643c48000041000045003c4b64003f643c4d003c3f00004b00004f640043640048640054643c5400004f000043000048003c4064005464004c643c54003c4c00004000004f640046640043640048640054643c5400004300004f000046000048003c45640035640054640040643c54000045003c35000046640041640056643c56000041000046003c4000004564003c64005464003e643c54000045000048640051643c5100004800003c00004564004164004d643c4d000041000045003c3e00004664003c64004f640041643c4f000046003c3c00004d640046640051640043643c4300004600005100004d003c4100004c64003c64004f640040641e4c001e4f00004a64004d641e4a001e4d00003c00004364004664004a643c4a000040000043000046003c35640048640040643c4c643c4c00003500004d640041640045643c4500004d00004100004f643c4f00004000005164003c64003e643c5100004c643c4c00003c00004d640045640041643c4100004d000045000051643c5100003e00005464004164003c643c54000048003c3c00004364004664004a643c4a00004600004300004c643c4c00004100003c64004d640040643c4d00004f643c4f00003c000046640043640051643c51000040000046000043000052643c52000045640035640054640040643c54000045003c35000041640046640056643c56000046000041003c4000004564003c64005464003e643c54000045000051643c5100003c00004864004164004f640045643c4500004100004f00004800004d643c4d00003e00004664003c64004f640041643c4f000046003c3c00004364004664004f643c4f000046000043000048640051643c5100004800004100004664003c64004f640040643c4f00004600004d643c4d00003c00004664004364004a641e46001e4a00004300004864144a640a48000a4c640a4a000a4000003564004d640041640a4c003245641441000046640a45000a48640a46000a3500005264004a640041640a48003241003c4a00005200003c640051640048643c48000051003c3c000045640041641e45001e41000045641446640a45000a48640a46000a3564005264004a640a4800324d003c5200003500004a000045640041640051640048643c48000045000041000051003c41640045640035640051640048643c48000035000041000045000051003c4a643c4a00004b643c4b00004864003c640052643c52003c3c00004800004364003f64004a643c4a00003f00004300004b641446641445640a46000a4b00004364003c640052640a45003252003c3c00004664003f64004a643c4a00004300004600003f00004164004b643c4b00004100003f64003c640052643c52003c3c000043640046640054643c5400003f00004300004600143f641440640a3f000a41640051640035640a40006e3500004564003f643c3f000045003c4100003e64003a643c51003c3a000041640046640052643c52000046000041003c35640051643c5100004d64143e00284d00003500004664004164003e64004a641e3e000a3f64144600004a000041000a3f000a40641e40000a4164003a64004f64783a00003e640046643c4600003e00144100283a64004164644100143a000046640043640040643c4300004f000046003c4000003c64003f64783c000043640048640051643c51000048000043003c3c64004f643c4f00004b643c4b00003c000043640048643c4800004300003f00004b643c4b00003c64003f64004f643c4f003c3c000048640043640052643c52000043000048003c3f000035640041640051643c51000052643c5200003500003f640045640048640054643c5400004500004800003f003c4100003a64004d643c3e64143f640a3e000a3f00004064143a00003e640041640045640048640a4000323e00144500284100004800003e64004364004664784600004300003e000035643c3500003e64143f640a3e000a40640a3f000a4164004564004864003a640a4000464500284800004100003a00003e640043640046643c4600004300003e003c3e64004364004664003a643c4600004300004d00003e003c3a00004164003e640045643c4500003e000041000046643c4600004a64003e64003a64004d641e4d000a4f64144a000a4f000a4d641e4d000a3a000041640045643c45000041000046643c4600004a64003a64004d641e4d000a4f64144a000a4f000a3e00004d641e4d000a3a00004164003e640045643c4500003e000041000046643c4600004a64003e64003a64004d643c4d00004a003c3a00004664004164004f643c4f00004100004600283e00144064003c64004c64644000143c000040640043640048643c48000043000040000046643c4600004c00004564003564783500004864004164004d643c4d000041000048003c3c64004c643c4c000045000048643c4800003c000041640045643c45000041003c4a640035640041641e41000a43641e43000a45641e45000a3500004d64004164004664144a000a46000a4864144100004d000a48000a4a641e4a000a4b64003c641e4b000a4c641e4c000a4d641e4d000a3c00004864004564004164004f641e4f000a51641448000041000045000a51000a52641e52000a4064004664004864004c64005464003c643c3c00004600004800004000005400004c003c48640054643c54000048003c4364004f643c4f00004300004164004d643c4d00004100003c640048643c4800003c003c4164004d643c4d000041003c4364004f643c4f000043000048640054643c5400004800004364004f643c4f000043003c4164004d643c4d00004100003c640048643c4800003c00004164004d643c4d00004100004364004f643c4f000043000048640054643c54000048003c4364004f643c4f000043003c4164004d643c4d00004100' +
        // '7f7e64' + '353c64' + // Clap
        '3c3c64' +
        '0040640046640048643c4800003c000040000046003c54643c54003c54643c54003c54643c54002856641435640054640040640a56003254003c35000045640041640056643c56000041000045003c4000003c64005464003e643c54000051643c5100003c00004564004164004d643c4d000041000045003c3e00003c64004f640041643c4f003c3c000046640051640043643c43000051000046003c4100003c64004f640040643c4f00004d643c4d00003c00004364004664004a643c4a000040000043000046003c35640048640040647835000041640045643c45000041003c4000003c64003e64783c000045640041643c41000045003c3e00004164003c643c48003c3c00004364004664004a643c4a00004600004300004c643c4c00004100003c64004d640040643c4d00004f643c4f00003c000046640043640051643c51000040000046000043000052643c52000035640054640040643c54003c35000041640045640056643c56000045000041003c4000003c64005464003e643c54000051643c5100003c00004164004f640045643c4500004f00004100004d643c4d00003e00003c64004f640041643c4f003c3c00004364004664004f643c4f000046000043000051643c5100004100003c64004f640040643c4f00004d643c4d00003c00004664004364004a643c4a000043000046003c4000003564004d640041645041002835000045640041640048643c48000041000045003c3c64004a64784a00003c000045640041640048643c48000041000045003c4b64003f643c4d003c3f00004b00004f640043640048640054643c5400004f000043000048003c4064005464004c643c54003c4c00004000004f640046640043640048640054643c5400004300004f000046000048003c45640035640054640040643c54000045003c35000046640041640056643c56000041000046003c4000004564003c64005464003e643c54000045000048640051643c5100004800003c00004564004164004d643c4d000041000045003c3e00004664003c64004f640041643c4f000046003c3c00004d640046640051640043643c4300004600005100004d003c4100004c64003c64004f640040641e4c001e4f00004a64004d641e4a001e4d00003c00004364004664004a643c4a000040000043000046003c35640048640040643c4c643c4c00003500004d640041640045643c4500004d00004100004f643c4f00004000005164003c64003e643c5100004c643c4c00003c00004d640045640041643c4100004d000045000051643c5100003e00005464004164003c643c54000048003c3c00004364004664004a643c4a00004600004300004c643c4c00004100003c64004d640040643c4d00004f643c4f00003c000046640043640051643c51000040000046000043000052643c52000045640035640054640040643c54000045003c35000041640046640056643c56000046000041003c4000004564003c64005464003e643c54000045000051643c5100003c00004864004164004f640045643c4500004100004f00004800004d643c4d00003e00004664003c64004f640041643c4f000046003c3c00004364004664004f643c4f000046000043000048640051643c5100004800004100004664003c64004f640040643c4f00004600004d643c4d00003c00004664004364004a641e46001e4a00004300004864144a640a48000a4c640a4a000a4000004564003564004d640041640a4c00324d000045000041003c3500004164004864004c640051640054643c5400004c000041000048000051003c4164004c640051640054640048643c4800005100004100004c000054003c4864003c64004c640051640054643c5400004c00004800003c00005100285664144164003564004c640051640054640a5600325100004c000041000054003c3500004064004564004864004c64004f643c4f00004800004000004500004c003c4064004564004c64004864004f643c4f00004c000040000045000048003c3c64004564004c64004f640048643c4800004c00003c00004500004f00285164144164003564004564004c64004864004f640a5100324800004c00004500004100004f003c3500004564004164003e640048643c4800004500004100003e003c4164003e640048640045643c4500004100003e000048003c3c64003e640041640045640048643c4800004100003c00003e000045003c3564004164004864004564004d643c4d000048000035000041000045003c4564004d641e4d000045000a48640051641e51000048000a4d640054641e5400004d000a3564004164004864004564005164005664644500144564145100145164785100004500004800003500005600004100' +
        '3c7f64'
    }
    
    var notesUsed = []

    function preprocessMIDI() {    
        console.log('preprocess midi')

        var musicAscii = readMusic()
        var music = []
        
        var i = 0
        var state = 'deltaTimeStart'
        var event
        var timer = 0

        while(i < musicAscii.length) {
            var byte = parseInt('0x' + musicAscii[i] + musicAscii[i+1])
            i += 2

            if(byte >= 0xF8) {
                continue
            }

            if(state == 'deltaTimeStart') {
                event = {}
                event.deltaTime = byte & 0b01111111

                if(byte & 0b10000000) {
                    state = 'deltaTimeMore'
                }

                else {
                    timer += event.deltaTime
                    event.time = timer
                    state = 'key'
                }
            }

            else if(state == 'deltaTimeMore') {
                event.deltaTime = event.deltaTime << 7
                event.deltaTime += byte & 0b01111111
                
                if(byte & 0b10000000) {
                    state = 'deltaTimeMore'
                }

                else {
                    timer += event.deltaTime
                    event.time = timer
                    state = 'key'
                }
            }

            else if (state == 'key') {
                event.noteNumber = byte
                event.noteName = getNoteName(event.noteNumber)
                
                if(!notesUsed.includes(event.noteName)) {
                    notesUsed.push(event.noteName)
                }
                
                state = 'velocity'
            }

            else if(state == 'velocity') {
                event.velocity = byte
                if(event.velocity) {
                    event.on = true
                } else {
                    event.on = false
                }

                state = 'deltaTimeStart'
                music.push(event)
            }

            else {
                console.log('Invalid state:', state)
            }
        }

        // console.log(music)
        document.querySelector('[name="notes-used"]').textContent = JSON.stringify(notesUsed)
        
        var musicNotation = document.querySelector('[name="music-notation"]')
        musicNotation.textContent = JSON.stringify(music, null, 2)

        return music
    }

    function getNoteName(noteNumber) {
        if(noteNumber == 127) return 'Horse'
        if(noteNumber == 126) return 'Clap'
        
        var notes = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B']
        return notes[noteNumber % 12] + (Math.floor(noteNumber / 12) - 1)
    }
</script>

</body>
</html>
        